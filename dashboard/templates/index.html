<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        body { background: #0d1117; color: #c9d1d9; }
        .stat-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-label { color: #8b949e; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .pnl-positive { color: #3fb950; }
        .pnl-negative { color: #f85149; }
        .badge-monitored { background: #1f6feb; }
        .badge-flagged { background: #f85149; }
        .badge-open { background: #3fb950; }
        .badge-closed { background: #8b949e; }
        .badge-buy { background: #3fb950; }
        .badge-sell { background: #f0883e; }
        .table { color: #c9d1d9; }
        .table thead th { border-color: #30363d; color: #8b949e; font-size: 0.8rem; text-transform: uppercase; }
        .table td { border-color: #21262d; vertical-align: middle; }
        .nav-pills .nav-link { color: #8b949e; border-radius: 8px; }
        .nav-pills .nav-link.active { background: #1f6feb; color: #fff; }
        .addr { font-family: monospace; font-size: 0.85rem; }
        .header-bar { background: #161b22; border-bottom: 1px solid #30363d; padding: 12px 0; margin-bottom: 24px; }
        .score-bar { height: 6px; border-radius: 3px; background: #21262d; }
        .score-fill { height: 100%; border-radius: 3px; }
        #pnlChart { max-height: 250px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #8b949e; }
        .empty-state h5 { color: #c9d1d9; }
    </style>
</head>
<body>

<!-- Header -->
<div class="header-bar">
    <div class="container-fluid px-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Solana Copy Trading Bot</h5>
            </div>
            <div>
                <span id="mode-badge" class="badge bg-secondary me-2">—</span>
                <span id="status-badge" class="badge bg-secondary">—</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4" id="mainTabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="overview">Overview</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="wallets">Wallets</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="tokens">Tokens</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="trades">Trades</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="positions">Positions</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div id="tab-overview"></div>
    <div id="tab-wallets" style="display:none"></div>
    <div id="tab-tokens" style="display:none"></div>
    <div id="tab-trades" style="display:none"></div>
    <div id="tab-positions" style="display:none"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =========================================================================
// Tab Navigation
// =========================================================================
const tabs = document.querySelectorAll('[data-tab]');
let activeTab = 'overview';
let pnlChart = null;

tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + name).style.display = 'block';
        activeTab = name;
        loadTab(name);
    });
});

// =========================================================================
// Helpers
// =========================================================================
function fmt(n, decimals = 4) {
    if (n === null || n === undefined) return '—';
    return Number(n).toFixed(decimals);
}

function fmtPnl(n) {
    if (n === null || n === undefined) return '—';
    const v = Number(n);
    const cls = v >= 0 ? 'pnl-positive' : 'pnl-negative';
    const sign = v >= 0 ? '+' : '';
    return `<span class="${cls}">${sign}${v.toFixed(6)} SOL</span>`;
}

function fmtUsd(n) {
    if (!n) return '—';
    const v = Number(n);
    if (v >= 1_000_000) return '$' + (v / 1_000_000).toFixed(2) + 'M';
    if (v >= 1_000) return '$' + (v / 1_000).toFixed(1) + 'K';
    if (v >= 1) return '$' + v.toFixed(2);
    return '$' + v.toFixed(8);
}

function shortAddr(addr) {
    if (!addr || addr.length < 12) return addr || '—';
    return addr.slice(0, 6) + '...' + addr.slice(-4);
}

function scoreColor(score) {
    if (score >= 80) return '#3fb950';
    if (score >= 60) return '#f0883e';
    return '#f85149';
}

async function fetchApi(endpoint) {
    const res = await fetch(endpoint);
    return res.json();
}

// =========================================================================
// Tab Loaders
// =========================================================================
async function loadTab(name) {
    switch (name) {
        case 'overview': return loadOverview();
        case 'wallets': return loadWallets();
        case 'tokens': return loadTokens();
        case 'trades': return loadTrades();
        case 'positions': return loadPositions();
    }
}

async function loadOverview() {
    const data = await fetchApi('/api/overview');

    // Update header badges
    const modeEl = document.getElementById('mode-badge');
    modeEl.textContent = data.trading_mode.toUpperCase();
    modeEl.className = 'badge me-2 ' + (data.trading_mode === 'live' ? 'bg-danger' : 'bg-info');

    const statusEl = document.getElementById('status-badge');
    statusEl.textContent = data.trading_paused ? 'PAUSED' : 'RUNNING';
    statusEl.className = 'badge ' + (data.trading_paused ? 'bg-warning' : 'bg-success');

    const el = document.getElementById('tab-overview');
    el.innerHTML = `
        <!-- Stat Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Open Positions</div>
                    <div class="stat-value">${data.open_positions}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Invested</div>
                    <div class="stat-value">${fmt(data.total_invested, 4)} <small class="text-muted">SOL</small></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Unrealized PnL</div>
                    <div class="stat-value">${fmtPnl(data.unrealized_pnl)}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">All-Time PnL</div>
                    <div class="stat-value">${fmtPnl(data.all_time_pnl)}</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Monitored Wallets</div>
                    <div class="stat-value">${data.monitored_wallets}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Wallets Scored</div>
                    <div class="stat-value">${data.total_wallets}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Tokens Discovered</div>
                    <div class="stat-value">${data.total_tokens}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Today's PnL</div>
                    <div class="stat-value">${fmtPnl(data.today_pnl)}</div>
                    <div class="text-muted" style="font-size:0.8rem">${data.today_buys} buys, ${data.today_sells} sells</div>
                </div>
            </div>
        </div>

        <!-- PnL Chart -->
        <div class="stat-card mb-4">
            <h6 class="text-muted mb-3">Daily PnL</h6>
            <canvas id="pnlChart"></canvas>
        </div>

        <!-- Recent Trades -->
        <div class="stat-card">
            <h6 class="text-muted mb-3">Recent Trades</h6>
            ${data.recent_trades.length > 0 ? `
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Time</th><th>Token</th><th>Side</th><th>Amount</th><th>Status</th>
                    </tr></thead>
                    <tbody>
                        ${data.recent_trades.map(t => `
                        <tr>
                            <td>${t.created_at || '—'}</td>
                            <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                            <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                            <td>${fmt(t.amount_sol, 6)} SOL</td>
                            <td>${t.status}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>` : '<div class="text-muted">No trades yet</div>'}
        </div>
    `;

    // Load PnL chart
    loadPnlChart();
}

async function loadPnlChart() {
    const data = await fetchApi('/api/daily_pnl');
    const days = data.daily_pnl;

    const canvas = document.getElementById('pnlChart');
    if (!canvas) return;

    if (pnlChart) pnlChart.destroy();

    if (days.length === 0) {
        canvas.parentElement.innerHTML += '<div class="text-muted text-center py-3">No daily data yet</div>';
        return;
    }

    let cumulative = 0;
    const cumulativeData = days.map(d => {
        cumulative += d.total_pnl_sol;
        return cumulative;
    });

    pnlChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: days.map(d => d.date),
            datasets: [
                {
                    label: 'Daily PnL (SOL)',
                    data: days.map(d => d.total_pnl_sol),
                    borderColor: '#1f6feb',
                    backgroundColor: 'rgba(31,111,235,0.1)',
                    tension: 0.3,
                    fill: true,
                },
                {
                    label: 'Cumulative PnL (SOL)',
                    data: cumulativeData,
                    borderColor: '#3fb950',
                    backgroundColor: 'rgba(63,185,80,0.05)',
                    tension: 0.3,
                    fill: true,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#8b949e' } } },
            scales: {
                x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
            }
        }
    });
}

async function loadWallets() {
    const data = await fetchApi('/api/wallets');
    const el = document.getElementById('tab-wallets');

    if (data.wallets.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No wallets scored yet</h5>
            <p>Run discovery + analysis first:</p>
            <code>python main.py --discover</code><br>
            <code>python main.py --analyze</code>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-muted mb-0">Smart Wallet Leaderboard (${data.wallets.length})</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>#</th><th>Address</th><th>Score</th><th>PnL</th>
                        <th>Win Rate</th><th>Trades</th><th>Timing</th><th>Status</th>
                    </tr></thead>
                    <tbody>
                        ${data.wallets.map((w, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td class="addr">${shortAddr(w.address)}</td>
                            <td>
                                <strong style="color:${scoreColor(w.total_score)}">${w.total_score.toFixed(0)}</strong>
                                <div class="score-bar mt-1"><div class="score-fill" style="width:${w.total_score}%; background:${scoreColor(w.total_score)}"></div></div>
                            </td>
                            <td>${fmtPnl(w.total_pnl_sol)}</td>
                            <td>${w.win_rate.toFixed(0)}%</td>
                            <td>${w.total_trades}</td>
                            <td>Rank ${w.avg_entry_rank || '—'}</td>
                            <td>
                                ${w.is_monitored ? '<span class="badge badge-monitored">Monitored</span>' : ''}
                                ${w.is_flagged ? '<span class="badge badge-flagged">' + (w.flag_reason || 'Flagged') + '</span>' : ''}
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

async function loadTokens() {
    const data = await fetchApi('/api/tokens');
    const el = document.getElementById('tab-tokens');

    if (data.tokens.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No tokens discovered yet</h5>
            <p>Run discovery:</p>
            <code>python main.py --discover</code>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="stat-card">
            <h6 class="text-muted mb-3">Discovered Tokens (${data.tokens.length})</h6>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>#</th><th>Symbol</th><th>Multiplier</th><th>Market Cap</th>
                        <th>Liquidity</th><th>Volume 24h</th><th>Holders</th><th>Source</th>
                    </tr></thead>
                    <tbody>
                        ${data.tokens.map((t, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td><strong>${t.symbol || '—'}</strong><br><span class="text-muted" style="font-size:0.75rem">${t.name || ''}</span></td>
                            <td><strong class="pnl-positive">${t.price_multiplier ? t.price_multiplier.toFixed(1) + 'x' : '—'}</strong></td>
                            <td>${fmtUsd(t.market_cap_usd)}</td>
                            <td>${fmtUsd(t.liquidity_usd)}</td>
                            <td>${fmtUsd(t.volume_24h_usd)}</td>
                            <td>${t.holder_count || '—'}</td>
                            <td>${t.data_source || '—'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

async function loadTrades() {
    const data = await fetchApi('/api/trades');
    const el = document.getElementById('tab-trades');

    if (data.trades.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No trades yet</h5>
            <p>Trades will appear here once the bot starts copying wallets.</p>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="stat-card">
            <h6 class="text-muted mb-3">Trade History (${data.trades.length})</h6>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Time</th><th>Token</th><th>Side</th><th>SOL</th>
                        <th>Price</th><th>Copied From</th><th>Reason</th><th>Status</th>
                    </tr></thead>
                    <tbody>
                        ${data.trades.map(t => `
                        <tr>
                            <td style="white-space:nowrap">${t.created_at || '—'}</td>
                            <td><strong>${t.token_symbol || shortAddr(t.token_mint)}</strong></td>
                            <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                            <td>${fmt(t.amount_sol, 6)}</td>
                            <td>${fmtUsd(t.price_usd)}</td>
                            <td class="addr">${shortAddr(t.triggered_by_wallet)}</td>
                            <td>${t.sell_reason || '—'}</td>
                            <td>${t.status}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

async function loadPositions() {
    const data = await fetchApi('/api/positions');
    const el = document.getElementById('tab-positions');

    if (data.positions.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No positions yet</h5>
            <p>Positions will appear here once the bot executes trades.</p>
        </div>`;
        return;
    }

    const open = data.positions.filter(p => p.status === 'open');
    const closed = data.positions.filter(p => p.status === 'closed');

    el.innerHTML = `
        <div class="stat-card mb-4">
            <h6 class="text-muted mb-3">Open Positions (${open.length})</h6>
            ${open.length > 0 ? `
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Invested</th><th>Entry</th><th>Current</th>
                        <th>Multiple</th><th>Unrealized PnL</th><th>Copied From</th>
                    </tr></thead>
                    <tbody>
                        ${open.map(p => `
                        <tr>
                            <td><strong>${p.token_symbol || shortAddr(p.token_mint)}</strong></td>
                            <td>${fmt(p.amount_sol_invested, 4)} SOL</td>
                            <td>${fmtUsd(p.entry_price_usd)}</td>
                            <td>${fmtUsd(p.current_price_usd)}</td>
                            <td>${p.multiplier ? '<strong>' + p.multiplier.toFixed(2) + 'x</strong>' : '—'}</td>
                            <td>${fmtPnl(p.unrealized_pnl_sol)}</td>
                            <td class="addr">${shortAddr(p.triggered_by_wallet)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>` : '<div class="text-muted">No open positions</div>'}
        </div>

        <div class="stat-card">
            <h6 class="text-muted mb-3">Closed Positions (${closed.length})</h6>
            ${closed.length > 0 ? `
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Invested</th><th>Realized PnL</th>
                        <th>Close Reason</th><th>Opened</th><th>Closed</th>
                    </tr></thead>
                    <tbody>
                        ${closed.map(p => `
                        <tr>
                            <td><strong>${p.token_symbol || shortAddr(p.token_mint)}</strong></td>
                            <td>${fmt(p.amount_sol_invested, 4)} SOL</td>
                            <td>${fmtPnl(p.realized_pnl_sol)}</td>
                            <td>${p.close_reason || '—'}</td>
                            <td>${p.opened_at || '—'}</td>
                            <td>${p.closed_at || '—'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>` : '<div class="text-muted">No closed positions</div>'}
        </div>
    `;
}

// =========================================================================
// Initial Load
// =========================================================================
loadOverview();

// Auto-refresh every 30 seconds
setInterval(() => loadTab(activeTab), 30000);
</script>
</body>
</html>
