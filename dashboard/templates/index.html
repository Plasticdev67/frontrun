<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROME AGENT TRADER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Inter:wght@300;400;500;600&family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        /* ========================================
           CSS CUSTOM PROPERTIES — ROMAN THEME
           ======================================== */
        :root {
            --bg-primary: #f5f0e8;
            --bg-secondary: #ece6d9;
            --bg-card: rgba(255, 253, 247, 0.7);
            --bg-card-hover: rgba(255, 253, 247, 0.9);
            --border-color: #c4b99a;
            --border-light: #d9d0bc;
            --border-gold: #b8960c;
            --text-primary: #2a2520;
            --text-secondary: #5a5348;
            --text-dim: #8a8070;
            --accent-gold: #b8960c;
            --accent-gold-light: #d4af37;
            --accent-green: #2d6b3f;
            --accent-red: #8b2c2c;
            --accent-amber: #8b6914;
            --font-display: 'Cinzel', serif;
            --font-serif: 'Cormorant Garamond', serif;
            --font-body: 'Inter', sans-serif;
            --shadow-card: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-card-hover: 0 4px 20px rgba(0,0,0,0.1);
            --texture: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23f5f0e8'/%3E%3Crect width='1' height='1' fill='%23ede8dd' opacity='0.5'/%3E%3C/svg%3E");
        }

        /* ========================================
           GLOBAL RESET & BODY
           ======================================== */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            background: var(--bg-primary);
            background-image: var(--texture);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 13px;
            line-height: 1.6;
            overflow-x: hidden;
            margin: 0;
        }
        /* Large faint bust outline watermark on dashboard — like Mozaic's helmet */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85vh;
            height: 85vh;
            background: url('/static/images/bust-outline.png') center/contain no-repeat;
            opacity: 0.06;
            pointer-events: none;
            z-index: 0;
        }

        /* ========================================
           SPLASH SCREEN — CRT SURVEILLANCE MONITOR
           ======================================== */
        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            background-image: var(--texture);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            overflow: hidden;
        }
        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Large bust watermark behind everything on splash */
        .splash-bg-bust {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75vh;
            height: 75vh;
            background: url('/static/images/bust-outline.png') center/contain no-repeat;
            opacity: 0.08;
            z-index: 1;
            pointer-events: none;
        }

        /* CRT TV static noise — animated canvas overlay */
        .crt-static {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2;
            opacity: 0.04;
            mix-blend-mode: multiply;
            pointer-events: none;
        }

        /* Horizontal scan lines — subtle on cream */
        .crt-scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 3px,
                rgba(0, 0, 0, 0.03) 3px,
                rgba(0, 0, 0, 0.03) 6px
            );
            z-index: 3;
            pointer-events: none;
            animation: scanlineShift 0.1s steps(2) infinite;
        }

        /* Moving scan bar */
        .crt-scanbar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.02), transparent);
            z-index: 4;
            pointer-events: none;
            animation: scanbar 4s linear infinite;
        }

        /* Subtle vignette flicker */
        .splash-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.08) 100%);
            z-index: 5;
            pointer-events: none;
            animation: crtFlicker 0.15s infinite;
        }

        @keyframes scanlineShift {
            0% { transform: translateY(0); }
            100% { transform: translateY(6px); }
        }
        @keyframes scanbar {
            0% { top: -2%; }
            100% { top: 102%; }
        }
        @keyframes crtFlicker {
            0% { opacity: 1; }
            50% { opacity: 0.97; }
            100% { opacity: 1; }
        }

        /* Title text — "Rome Agent" */
        .splash-title {
            position: relative;
            z-index: 6;
            margin-top: 0;
            font-family: var(--font-display);
            font-size: 18px;
            letter-spacing: 10px;
            color: var(--accent-gold);
            text-transform: uppercase;
            opacity: 0;
            animation: heroFadeIn 2s ease 0.5s forwards;
        }

        /* "Click to enter" prompt */
        .splash-enter {
            position: relative;
            z-index: 6;
            margin-top: 12px;
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 5px;
            color: var(--text-dim);
            text-transform: uppercase;
            opacity: 0;
            animation: heroFadeIn 1.5s ease 1.2s forwards, splashPulse 3s ease 2.5s infinite;
        }

        @keyframes heroFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes splashPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Compass star in corner */
        .compass-star {
            position: fixed;
            top: 24px;
            right: 28px;
            font-size: 18px;
            color: var(--accent-gold);
            opacity: 0.5;
            z-index: 100;
            cursor: default;
        }

        /* ========================================
           SCROLLBAR
           ======================================== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* ========================================
           HEADER BAR
           ======================================== */
        .header-bar {
            background: transparent;
            padding: 24px 0 8px 0;
            margin-bottom: 0;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .brand-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 1.5px solid var(--border-color);
        }
        .brand-name {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 4px;
            color: var(--text-primary);
        }
        .brand-subtitle {
            font-family: var(--font-serif);
            font-size: 12px;
            font-style: italic;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .header-status {
            text-align: right;
            font-family: var(--font-body);
        }

        /* ========================================
           GOBLET SYNC BUTTON (near tab bar)
           ======================================== */
        .goblet-sync {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 14px;
            cursor: pointer;
            color: var(--accent-gold);
            transition: all 0.3s ease;
            font-family: var(--font-display);
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-left: auto;
        }
        .goblet-sync:hover {
            border-color: var(--accent-gold);
            background: rgba(184, 150, 12, 0.08);
            transform: scale(1.03);
        }
        .goblet-sync:active {
            transform: scale(0.97);
        }
        .goblet-sync.syncing .goblet-icon {
            animation: gobletPulse 1.2s ease-in-out infinite;
        }
        .goblet-sync.syncing {
            border-color: var(--accent-gold);
            box-shadow: 0 0 12px rgba(184, 150, 12, 0.25);
        }
        .goblet-sync .sync-time {
            font-family: var(--font-body);
            font-size: 9px;
            color: var(--text-dim);
            letter-spacing: 0.5px;
        }
        @keyframes gobletPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
        }
        .goblet-icon {
            transition: transform 0.3s ease;
        }

        /* ========================================
           NAVIGATION
           ======================================== */
        .nav-roman {
            display: flex;
            align-items: center;
            gap: 0;
            margin: 16px 0 24px 0;
            padding: 0;
            list-style: none;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 12px;
        }
        .nav-roman .nav-item { position: relative; }
        .nav-roman .nav-link {
            color: var(--text-dim);
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 8px 24px;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
            background: none;
        }
        .nav-roman .nav-link:hover {
            color: var(--text-primary);
        }
        .nav-roman .nav-link.active {
            color: var(--accent-gold);
        }
        .nav-roman .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 24px;
            right: 24px;
            height: 2px;
            background: var(--accent-gold);
        }
        .nav-separator {
            color: var(--border-color);
            font-size: 8px;
            padding: 0 4px;
        }

        /* ========================================
           CARDS — GLASS PARCHMENT
           ======================================== */
        .rome-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-card);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        .rome-card:hover {
            box-shadow: var(--shadow-card-hover);
        }
        .card-header-rome {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header-rome .title-text {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 3px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .card-header-rome .count-text {
            font-family: var(--font-body);
            font-size: 10px;
            color: var(--text-dim);
        }
        .card-body-inner { padding: 20px; }

        /* ========================================
           STAT VALUES & LABELS
           ======================================== */
        .stat-value {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .stat-label {
            font-family: var(--font-display);
            color: var(--text-dim);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }
        .stat-mini {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 14px 16px;
            text-align: center;
        }

        /* ========================================
           PNL COLORS
           ======================================== */
        .pnl-positive { color: var(--accent-green); font-weight: 500; }
        .pnl-negative { color: var(--accent-red); font-weight: 500; }

        /* ========================================
           TABLE STYLES
           ======================================== */
        .table {
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 12px;
            border-collapse: collapse;
            --bs-table-bg: transparent;
            --bs-table-color: var(--text-primary);
            --bs-table-border-color: var(--border-light);
            --bs-table-hover-bg: rgba(184, 150, 12, 0.04);
            --bs-table-hover-color: var(--text-primary);
        }
        .table thead th {
            border-bottom: 1px solid var(--border-color);
            color: var(--text-dim);
            font-family: var(--font-display);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 10px 8px;
            font-weight: 500;
        }
        .table td {
            border-bottom: 1px solid var(--border-light);
            padding: 8px;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover { cursor: pointer; }

        /* ========================================
           BADGES
           ======================================== */
        .badge-buy {
            background: var(--accent-green) !important;
            color: #fff !important;
            font-weight: 500;
            font-size: 10px;
            border-radius: 3px;
        }
        .badge-sell {
            background: var(--accent-amber) !important;
            color: #fff !important;
            font-weight: 500;
            font-size: 10px;
            border-radius: 3px;
        }
        .badge-open {
            background: var(--accent-green) !important;
            color: #fff !important;
            font-size: 10px;
        }
        .badge-closed {
            background: var(--text-dim) !important;
            font-size: 10px;
        }
        .badge-monitored {
            background: transparent !important;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold) !important;
            font-size: 9px;
            letter-spacing: 1px;
        }
        .badge-flagged {
            background: transparent !important;
            border: 1px solid var(--accent-red);
            color: var(--accent-red) !important;
            font-size: 9px;
        }
        .badge-mode-live {
            background: var(--accent-red) !important;
            color: #fff !important;
        }
        .badge-mode-dry {
            background: var(--accent-amber) !important;
            color: #fff !important;
        }
        .badge-mode-alert {
            background: var(--text-dim) !important;
            color: #fff !important;
        }

        /* ========================================
           PULSE DOT
           ======================================== */
        .pulse-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse-breathe 2s ease-in-out infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        .pulse-dot-amber { background: var(--accent-amber); }
        @keyframes pulse-breathe {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ========================================
           SCORE BARS
           ======================================== */
        .score-bar {
            height: 3px;
            background: var(--border-light);
            border-radius: 2px;
            margin-top: 4px;
        }
        .score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* ========================================
           ADDRESS STYLES
           ======================================== */
        .addr {
            font-family: 'Inter', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .addr-copy {
            cursor: pointer;
            border-bottom: 1px dashed var(--border-color);
            transition: color 0.2s;
        }
        .addr-copy:hover { color: var(--accent-gold); }

        /* ========================================
           LOADING & EMPTY STATES
           ======================================== */
        .loading-text {
            color: var(--text-dim);
            text-align: center;
            padding: 40px;
            font-family: var(--font-serif);
            font-size: 16px;
            font-style: italic;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        .empty-state h5 {
            font-family: var(--font-display);
            font-weight: 500;
            letter-spacing: 3px;
            color: var(--text-secondary);
        }
        .empty-state code {
            color: var(--accent-gold);
            background: var(--bg-secondary);
            padding: 3px 10px;
            border: 1px solid var(--border-light);
            border-radius: 3px;
            font-size: 12px;
        }

        /* ========================================
           MODAL
           ======================================== */
        .terminal-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .terminal-modal {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 850px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-titlebar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            border-radius: 12px 12px 0 0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-display);
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 3px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .modal-close {
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-body);
            padding: 4px 12px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: #fff;
        }
        .modal-body-inner { padding: 24px; }

        /* ========================================
           CHART CONTAINERS
           ======================================== */
        .chart-container { position: relative; padding: 16px; }
        .chart-container canvas { max-height: 250px; }
        .chart-small canvas { max-height: 200px; }

        /* ========================================
           TICKER BAR
           ======================================== */
        .ticker-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            overflow: hidden;
            white-space: nowrap;
            height: 32px;
            line-height: 32px;
            font-size: 11px;
            color: var(--text-dim);
            position: relative;
        }
        .ticker-content {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 40s linear infinite;
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* ========================================
           FADE IN ANIMATION
           ======================================== */
        .fade-up {
            opacity: 0;
            transform: translateY(12px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-up:nth-child(2) { animation-delay: 0.05s; }
        .fade-up:nth-child(3) { animation-delay: 0.1s; }
        .fade-up:nth-child(4) { animation-delay: 0.15s; }

        /* ========================================
           CUSTOM CURSOR
           ======================================== */
        body { cursor: default; }
        a, button, .addr-copy, .table-hover tbody tr, [onclick] {
            cursor: pointer;
        }

        /* ========================================
           HOVER LIFT EFFECT ON CARDS
           ======================================== */
        .rome-card {
            transition: box-shadow 0.3s ease, transform 0.25s ease;
        }
        .rome-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-card-hover);
        }

        /* ========================================
           SMOOTH PAGE TRANSITIONS
           ======================================== */
        [id^="tab-"] {
            animation: tabFadeIn 0.4s ease;
        }
        @keyframes tabFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           MUSIC TOGGLE
           ======================================== */
        .music-toggle {
            position: fixed;
            bottom: 24px;
            right: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-card);
        }
        .music-toggle:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }
        .music-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 14px;
        }
        .music-bars .bar {
            width: 3px;
            background: var(--accent-gold);
            border-radius: 1px;
            transition: height 0.2s ease;
        }
        .music-bars.playing .bar:nth-child(1) { animation: musicBar 0.8s ease infinite; }
        .music-bars.playing .bar:nth-child(2) { animation: musicBar 0.6s ease 0.1s infinite; }
        .music-bars.playing .bar:nth-child(3) { animation: musicBar 0.7s ease 0.2s infinite; }
        .music-bars.playing .bar:nth-child(4) { animation: musicBar 0.5s ease 0.15s infinite; }
        .music-bars:not(.playing) .bar { height: 3px !important; }
        @keyframes musicBar {
            0%, 100% { height: 4px; }
            50% { height: 14px; }
        }

        /* ========================================
           RESPONSIVE — MOBILE
           ======================================== */
        @media (max-width: 768px) {
            /* Header — stack brand + status vertically */
            .header-bar { padding: 16px 0 8px 0; }
            .header-bar .d-flex {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }
            .header-status { text-align: left; margin-top: 4px; }
            .brand-name { font-size: 15px; letter-spacing: 2px; }
            .brand-avatar { width: 36px; height: 36px; }
            .brand-subtitle { font-size: 11px; }

            /* Navigation — horizontal scroll with no overflow clipping */
            .nav-roman {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                margin: 12px -16px 20px -16px;
                padding: 0 16px 12px 16px;
                gap: 0;
                scrollbar-width: none;
            }
            .nav-roman::-webkit-scrollbar { display: none; }
            .nav-roman .nav-link {
                padding: 8px 10px;
                font-size: 9px;
                letter-spacing: 1px;
                white-space: nowrap;
            }
            .nav-separator { padding: 0 2px; }

            /* Hero quote */
            .hero-quote {
                font-size: 17px;
                padding: 8px 8px 16px;
            }

            /* Container padding — prevent left/right clip */
            .container-fluid.px-4 {
                padding-left: 16px !important;
                padding-right: 16px !important;
            }

            /* Cards */
            .card-body-inner { padding: 14px; }
            .card-header-rome { padding: 10px 14px; }
            .stat-value { font-size: 1.4rem; }
            .stat-mini { padding: 10px 12px; }
            .stat-label { font-size: 8px; letter-spacing: 1.5px; }

            /* Tables — smaller text */
            .table { font-size: 11px; }
            .table thead th { font-size: 8px; letter-spacing: 1px; padding: 8px 6px; }
            .table td { padding: 6px; }
            .addr { font-size: 10px; }

            /* Compass star — tighter to edge */
            .compass-star { top: 16px; right: 16px; font-size: 14px; }

            /* Music toggle — avoid overlapping content */
            .music-toggle { bottom: 16px; right: 16px; }

            /* Bust watermark — smaller on mobile */
            body::before { width: 60vh; height: 60vh; }

            /* Charts — ensure they don't overflow */
            .chart-container { padding: 10px; }

            /* Wallets summary grid — 2x2 on mobile */
            .wallets-summary-grid { grid-template-columns: repeat(2, 1fr) !important; }
        }

        /* Extra small screens (iPhone SE etc) */
        @media (max-width: 375px) {
            .brand-name { font-size: 13px; letter-spacing: 1px; }
            .hero-quote { font-size: 15px; padding: 4px 4px 12px; }
            .nav-roman .nav-link { padding: 8px 8px; font-size: 8px; }
            .stat-value { font-size: 1.2rem; }
        }

        /* ========================================
           HERO QUOTE
           ======================================== */
        .hero-quote {
            font-family: var(--font-serif);
            font-size: 22px;
            font-style: italic;
            font-weight: 300;
            color: var(--text-secondary);
            text-align: center;
            padding: 8px 40px 20px;
            line-height: 1.4;
        }
        .hero-quote .attr {
            display: block;
            font-size: 11px;
            font-style: normal;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-top: 8px;
            font-family: var(--font-display);
        }

        /* ========================================
           PnL HERO — Command Center
           ======================================== */
        .pnl-hero {
            text-align: center;
            padding: 28px 20px !important;
        }
        .pnl-main {
            font-family: var(--font-serif);
            font-size: 2.8rem;
            font-weight: 700;
            margin: 8px 0 16px 0;
        }
        .pnl-period-row {
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        /* ========================================
           SMART MONEY CARDS
           ======================================== */
        .smart-money-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-card);
            transition: box-shadow 0.3s ease, transform 0.25s ease;
            overflow: hidden;
        }
        .smart-money-card:hover {
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-1px);
        }

        /* Expand chevron for side wallets */
        .expand-chevron {
            display: inline-block;
            font-size: 9px;
            color: var(--text-dim);
            margin-left: 6px;
            transition: transform 0.3s ease;
        }
        .expand-chevron.open {
            transform: rotate(90deg);
        }

        /* Side wallets section — collapsed by default */
        .side-wallets-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            padding: 0 16px;
        }
        .side-wallets-section.expanded {
            max-height: 500px;
            padding: 12px 16px;
        }

        /* Side wallet row */
        .side-wallet-row {
            display: grid;
            grid-template-columns: 14px 1fr 70px 70px 50px;
            gap: 8px;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 12px;
        }
        .side-wallet-row:last-child {
            border-bottom: none;
        }

        /* ========================================
           SOURCE BADGES — FOMO / GMGN / MANUAL
           ======================================== */
        .badge-source {
            display: inline-block;
            font-family: var(--font-display);
            font-size: 8px;
            letter-spacing: 1.5px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            vertical-align: middle;
        }
        .badge-source-fomo {
            background: rgba(184, 150, 12, 0.15);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }
        .badge-source-gmgn {
            background: rgba(45, 107, 63, 0.12);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }
        .badge-source-manual {
            background: rgba(138, 128, 112, 0.1);
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
        }

        /* ========================================
           COPY TOGGLE BUTTON
           ======================================== */
        .btn-toggle-copy {
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 2px;
            padding: 5px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .btn-toggle-copy:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }
        .btn-toggle-copy.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #fff;
        }
        .btn-toggle-copy.active:hover {
            background: var(--accent-amber);
            border-color: var(--accent-amber);
        }

        /* ========================================
           PROFIT INDICATOR DOT
           ======================================== */
        .profit-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 4px;
        }
        .profit-indicator.profitable {
            background: var(--accent-green);
            box-shadow: 0 0 4px rgba(45, 107, 63, 0.4);
        }
        .profit-indicator.unprofitable {
            background: var(--accent-red);
            box-shadow: 0 0 4px rgba(139, 44, 44, 0.4);
        }
        .profit-indicator.no-data {
            background: var(--border-color);
        }

        /* ========================================
           SIGNAL ROW — Live Feed
           ======================================== */
        .signal-row {
            display: grid;
            grid-template-columns: 70px 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s ease;
        }
        .signal-row:hover {
            background: rgba(184, 150, 12, 0.04);
        }
        .signal-row:last-child {
            border-bottom: none;
        }

        /* ========================================
           RESPONSIVE — NEW COMPONENTS
           ======================================== */
        @media (max-width: 768px) {
            .pnl-main { font-size: 2rem; }
            .pnl-period-row { gap: 20px; }
            .pnl-period-row > div div:last-child { font-size: 1rem !important; }

            .smart-money-card > div:first-child {
                padding: 10px 12px !important;
                gap: 8px !important;
            }
            .side-wallet-row {
                grid-template-columns: 14px 1fr 60px 60px 40px;
                gap: 4px;
                font-size: 11px;
            }
            .signal-row {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                padding: 8px 12px;
            }
            .signal-row > div:first-child {
                grid-column: 1 / -1;
            }
            .btn-toggle-copy {
                font-size: 8px;
                padding: 4px 8px;
            }
        }

        @media (max-width: 375px) {
            .pnl-main { font-size: 1.6rem; }
            .pnl-period-row { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>

<!-- ============================================
     SPLASH SCREEN
     ============================================ -->
<div class="splash-screen" id="splash" onclick="enterApp()">
    <!-- Large bust watermark background -->
    <div class="splash-bg-bust"></div>
    <!-- CRT static noise layer — rendered by JS canvas -->
    <canvas class="crt-static" id="crtStatic"></canvas>
    <!-- Scan lines overlay -->
    <div class="crt-scanlines"></div>
    <!-- Moving scan bar -->
    <div class="crt-scanbar"></div>
    <!-- Text -->
    <div class="splash-title">Rome Agent</div>
    <div class="splash-enter">Click to Enter</div>
</div>

<!-- Compass Star -->
<div class="compass-star" title="Rome Agent Trader">&#10022;</div>

<!-- Trade Ticker -->
<div class="ticker-bar">
    <div class="ticker-content" id="ticker-content">
        <span style="letter-spacing: 2px;">AWAITING TRADE SIGNALS . . .</span>
    </div>
</div>

<!-- Header -->
<div class="header-bar">
    <div class="container-fluid px-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-brand">
                <img src="/static/images/bust-outline.png" alt="Rome" class="brand-avatar">
                <div>
                    <div class="brand-name">ROME AGENT TRADER</div>
                    <div class="brand-subtitle">Veni, Vidi, Traded</div>
                </div>
            </div>
            <div class="header-status" style="display:flex; align-items:center; gap:16px;">
                <div>
                    <div>
                        <span class="pulse-dot" id="status-dot"></span>
                        <span id="status-text" style="font-size: 12px; letter-spacing: 1px; font-weight: 500;">INITIALIZING</span>
                    </div>
                    <div style="margin-top: 4px;">
                        <span id="mode-badge" style="font-size: 11px; color: var(--accent-amber); letter-spacing: 1px;">---</span>
                    </div>
                    <div style="margin-top: 4px; font-size: 10px; color: var(--text-dim);" id="last-refresh">
                        Last sync: --:--:--
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- Hero Quote -->
    <div class="hero-quote fade-up">
        "Accompany me, it is time for Rome to shine."
        <span class="attr">Romulus</span>
    </div>

    <!-- Navigation + Goblet Sync Button -->
    <ul class="nav-roman" id="mainTabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="command">Command Center</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="smart-money">Smart Money</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="live-feed">Live Feed</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="journal">Journal</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="fomo">FOMO Traders</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="agent">Agent Brain</a>
        </li>
        <li style="margin-left:auto;">
            <button class="goblet-sync" id="refreshBtn" onclick="manualRefresh()" title="Refresh data">
                <svg class="goblet-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <!-- Goblet/chalice SVG -->
                    <path d="M8 2h8l-1 8c0 2-1.5 3-3 3s-3-1-3-3L8 2z"/>
                    <path d="M5 2h14"/>
                    <path d="M12 13v4"/>
                    <path d="M8 21h8"/>
                    <path d="M8 17h8"/>
                    <!-- Liquid shimmer -->
                    <path d="M9.5 5h5" opacity="0.4"/>
                </svg>
                <span>SYNC</span>
                <span class="sync-time" id="goblet-sync-time"></span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div id="tab-command"></div>
    <div id="tab-smart-money" style="display:none"></div>
    <div id="tab-live-feed" style="display:none"></div>
    <div id="tab-journal" style="display:none"></div>
    <div id="tab-fomo" style="display:none"></div>
    <div id="tab-agent" style="display:none"></div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<!-- Music Toggle -->
<div class="music-toggle" id="musicToggle" onclick="toggleMusic()" title="Toggle ambient music">
    <div class="music-bars" id="musicBars">
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =========================================================================
// Chart.js Global Defaults — Roman Theme
// =========================================================================
Chart.defaults.color = '#8a8070';
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 11;

// =========================================================================
// Splash Screen
// =========================================================================
function enterApp() {
    // Start music on the splash click itself
    AudioSystem.init();
    AudioSystem.startMusic();
    document.getElementById('musicBars')?.classList.add('playing');
    document.getElementById('splash').classList.add('hidden');
    // Remember we've entered — skip splash on page refresh
    sessionStorage.setItem('rome_entered', '1');
}

// Auto-skip splash if already entered this session (browser refresh)
if (sessionStorage.getItem('rome_entered')) {
    document.getElementById('splash').classList.add('hidden');
}

// =========================================================================
// Tab Navigation
// =========================================================================
const tabs = document.querySelectorAll('[data-tab]');
let activeTab = 'command';

tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + name).style.display = 'block';
        activeTab = name;
        loadTab(name);
    });
});

// =========================================================================
// Helpers
// =========================================================================
function fmt(n, decimals = 4) {
    if (n === null || n === undefined) return '\u2014';
    return Number(n).toFixed(decimals);
}

function fmtPnl(n) {
    if (n === null || n === undefined) return '<span style="color:var(--text-dim)">\u2014</span>';
    const v = Number(n);
    const cls = v >= 0 ? 'pnl-positive' : 'pnl-negative';
    const sign = v >= 0 ? '+' : '';
    if (Math.abs(v) >= 1000) return `<span class="${cls}">${sign}${v.toFixed(1)} SOL</span>`;
    if (Math.abs(v) >= 1) return `<span class="${cls}">${sign}${v.toFixed(2)} SOL</span>`;
    return `<span class="${cls}">${sign}${v.toFixed(4)} SOL</span>`;
}

function fmtProfit(usd) {
    if (!usd) return '<span style="color:var(--text-dim)">\u2014</span>';
    const v = Number(usd);
    const cls = v >= 0 ? 'pnl-positive' : 'pnl-negative';
    const sign = v >= 0 ? '+' : '';
    if (Math.abs(v) >= 1_000_000) return `<span class="${cls}">${sign}$${(v / 1_000_000).toFixed(1)}M</span>`;
    if (Math.abs(v) >= 1_000) return `<span class="${cls}">${sign}$${(v / 1_000).toFixed(1)}K</span>`;
    return `<span class="${cls}">${sign}$${v.toFixed(0)}</span>`;
}

function renderTags(tags) {
    if (!tags || !tags.length) return '';
    const tagColors = {
        'smart_degen': '#4a8c5c', 'renowned': '#8b6914', 'sniper': '#c9302c',
        'fresh_wallet': '#5a5aad', 'whale': '#2d6b3f', 'insider': '#c9302c',
        'kol': '#8b6914', 'bot': '#8b2c2c',
    };
    return tags.slice(0, 3).map(t => {
        const color = tagColors[t] || 'var(--text-dim)';
        return `<span style="display:inline-block; font-size:9px; padding:1px 5px; border:1px solid ${color}; color:${color}; border-radius:3px; margin:1px 2px; letter-spacing:0.5px; font-family:var(--font-display);">${t.replace('_',' ')}</span>`;
    }).join('');
}

function fmtUsd(n) {
    if (!n) return '<span style="color:var(--text-dim)">\u2014</span>';
    const v = Number(n);
    if (v >= 1_000_000) return '$' + (v / 1_000_000).toFixed(2) + 'M';
    if (v >= 1_000) return '$' + (v / 1_000).toFixed(1) + 'K';
    if (v >= 1) return '$' + v.toFixed(2);
    return '$' + v.toFixed(8);
}

function shortAddr(addr) {
    if (!addr || addr.length < 12) return addr || '\u2014';
    return addr.slice(0, 6) + '\u00b7\u00b7\u00b7' + addr.slice(-4);
}

function scoreColor(score) {
    if (score >= 80) return '#2d6b3f';
    if (score >= 60) return '#4a8c5c';
    if (score >= 40) return '#8b6914';
    return '#8b2c2c';
}

async function fetchApi(endpoint) {
    try {
        const res = await fetch(endpoint);
        if (!res.ok) return null;
        return res.json();
    } catch (e) {
        return null;
    }
}

function updateRefreshTimer() {
    const now = new Date();
    document.getElementById('last-refresh').textContent =
        'Last sync: ' + now.toLocaleTimeString('en-US', { hour12: false });
}

async function manualRefresh() {
    const btn = document.getElementById('refreshBtn');
    if (btn.classList.contains('syncing')) return; // Prevent double-click
    btn.classList.add('syncing');
    AudioSystem.playClick();
    try {
        await loadTab(activeTab);
    } catch (e) {
        console.error('Refresh failed:', e);
    }
    // Keep animation for at least 800ms so it's visible
    setTimeout(() => {
        btn.classList.remove('syncing');
        // Update sync time display
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
        const syncTime = document.getElementById('goblet-sync-time');
        if (syncTime) syncTime.textContent = timeStr;
    }, 800);
}

// =========================================================================
// Animated Number Counter
// =========================================================================
function animateCounter(elementId, newValue, decimals = 4) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const start = parseFloat(el.dataset.val || '0');
    const end = newValue;
    const startTime = performance.now();
    const duration = 600;
    el.dataset.val = end;

    function update(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * eased;
        el.textContent = current.toFixed(decimals);
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

// =========================================================================
// Ticker
// =========================================================================
function updateTicker(trades) {
    const el = document.getElementById('ticker-content');
    if (!trades || trades.length === 0) {
        el.innerHTML = '<span style="letter-spacing:2px;">AWAITING TRADE SIGNALS . . .</span>';
        return;
    }
    const items = trades.map(t => {
        const side = t.side.toUpperCase();
        const symbol = t.token_symbol || 'UNKNOWN';
        const amount = Number(t.amount_sol).toFixed(4);
        const color = t.side === 'buy' ? 'var(--accent-green)' : 'var(--accent-amber)';
        const time = t.created_at ? t.created_at.split('T').pop().split('.')[0] : '';
        return `<span style="color:${color}; font-weight:500;">${side}</span> ${symbol} ${amount} SOL <span style="color:var(--text-dim)">${time}</span>`;
    });
    el.innerHTML = items.join(' &nbsp;\u2022&nbsp; ') + ' &nbsp;\u2022&nbsp; ' + items.join(' &nbsp;\u2022&nbsp; ');
    el.style.animationDuration = Math.max(20, items.length * 4) + 's';
}

// =========================================================================
// Copy to Clipboard
// =========================================================================
function copyAddr(address, event) {
    if (event) event.stopPropagation();
    navigator.clipboard.writeText(address).then(() => {
        const el = event ? event.target : null;
        if (el) {
            const orig = el.textContent;
            el.textContent = 'Copied!';
            el.style.color = 'var(--accent-gold)';
            setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1000);
        }
    });
}

// =========================================================================
// Modal System
// =========================================================================
function showModal(titleText, bodyHTML) {
    document.getElementById('modal-container').innerHTML = `
        <div class="terminal-modal-overlay" onclick="closeModal(event)">
            <div class="terminal-modal" onclick="event.stopPropagation()">
                <div class="modal-titlebar">
                    <span>${titleText}</span>
                    <button class="modal-close" onclick="closeModal()">Close</button>
                </div>
                <div class="modal-body-inner">${bodyHTML}</div>
            </div>
        </div>
    `;
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-container').innerHTML = '';
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') document.getElementById('modal-container').innerHTML = '';
});

// =========================================================================
// Score Bar Renderer
// =========================================================================
function renderScoreBar(label, score) {
    const s = score || 0;
    const color = scoreColor(s);
    return `
        <div style="margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; font-size:10px;">
                <span style="color:var(--text-dim); font-family:var(--font-display); letter-spacing:1px; font-size:9px;">${label}</span>
                <span style="color:${color}; font-weight:500;">${s.toFixed(0)}</span>
            </div>
            <div class="score-bar"><div class="score-fill" style="width:${s}%; background:${color};"></div></div>
        </div>
    `;
}

// =========================================================================
// Wallet Detail Modal
// =========================================================================
async function showWalletDetail(address) {
    showModal('Loading...', '<div class="loading-text">Querying wallet data...</div>');
    const data = await fetchApi('/api/wallet/' + encodeURIComponent(address));
    if (!data || !data.wallet) { closeModal(); return; }

    const w = data.wallet;
    const wr = w.gmgn_winrate != null ? w.gmgn_winrate * 100 : (w.win_rate || 0);
    const wrColor = wr >= 60 ? 'var(--accent-green)' : wr >= 40 ? '#8b6914' : 'var(--text-dim)';
    let html = `
        <div style="margin-bottom:20px;">
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px;">WALLET ADDRESS</div>
            <div class="addr-copy" onclick="copyAddr('${w.address}', event)"
                 style="font-size:13px; word-break:break-all; margin-top:4px;">
                ${w.address} <span style="color:var(--text-dim); font-size:9px;">[click to copy]</span>
            </div>
            <div style="margin-top:6px;">${renderTags(w.gmgn_tags)}</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            ${renderScoreBar('PNL SCORE', w.pnl_score)}
            ${renderScoreBar('WIN RATE', w.win_rate_score)}
            ${renderScoreBar('TIMING', w.timing_score)}
            ${renderScoreBar('CONSISTENCY', w.consistency_score)}
        </div>

        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:12px;">
            <div class="stat-mini">
                <div class="stat-label">TOTAL SCORE</div>
                <div style="font-size:1.4rem; font-weight:600; color:${scoreColor(w.total_score)};">${w.total_score.toFixed(0)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">30D PROFIT</div>
                <div style="font-size:1rem;">${fmtProfit(w.gmgn_profit_30d_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">WIN RATE</div>
                <div style="font-size:1.4rem; font-weight:600; color:${wrColor};">${wr > 0 ? wr.toFixed(0) + '%' : '\u2014'}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">30D TRADES</div>
                <div style="font-size:1.4rem; font-weight:600; color:${((w.gmgn_buy_30d||0)+(w.gmgn_sell_30d||0)) > 15000 ? '#ff4444' : 'var(--text-secondary)'};">${(() => { const t = (w.gmgn_buy_30d||0)+(w.gmgn_sell_30d||0); return t > 15000 ? (t/1000).toFixed(0)+'K BOT' : t > 0 ? t.toLocaleString() : w.total_trades || '\u2014'; })()}</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">ALL-TIME PROFIT</div>
                <div style="font-size:1rem;">${fmtProfit(w.gmgn_realized_profit_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">SOL BALANCE</div>
                <div style="font-size:1rem; color:var(--text-secondary);">${w.gmgn_sol_balance ? w.gmgn_sol_balance.toFixed(1) + ' SOL' : '\u2014'}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">AVG ENTRY</div>
                <div style="font-size:1rem; color:var(--text-secondary);">Rank ${w.avg_entry_rank || '\u2014'}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">UNIQUE WINS</div>
                <div style="font-size:1rem; color:var(--text-secondary);">${w.unique_winners || 0} tokens</div>
            </div>
        </div>
    `;

    if (data.token_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TOKEN TRADES (${data.token_trades.length})
            </div>
            <div class="table-responsive" style="margin-bottom:20px;">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Buy SOL</th><th>Sell SOL</th><th>PnL</th><th>Entry Rank</th>
                    </tr></thead>
                    <tbody>
                        ${data.token_trades.map(t => `
                        <tr>
                            <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                            <td>${fmt(t.buy_amount_sol, 4)}</td>
                            <td>${fmt(t.sell_amount_sol, 4)}</td>
                            <td>${fmtPnl(t.pnl_sol)}</td>
                            <td>${t.entry_rank || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    if (data.copy_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TRADES TRIGGERED (${data.copy_trades.length})
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Side</th><th>SOL</th><th>Price</th><th>Status</th><th>Time</th>
                    </tr></thead>
                    <tbody>
                        ${data.copy_trades.map(t => `
                        <tr>
                            <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                            <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                            <td>${fmt(t.amount_sol, 6)}</td>
                            <td>${fmtUsd(t.price_usd)}</td>
                            <td>${t.status}</td>
                            <td style="white-space:nowrap">${t.created_at || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    showModal('Wallet \u2014 ' + shortAddr(w.address), html);
}

// =========================================================================
// Token Detail Modal
// =========================================================================
async function showTokenDetail(mint) {
    showModal('Loading...', '<div class="loading-text">Querying token data...</div>');
    const data = await fetchApi('/api/token/' + encodeURIComponent(mint));
    if (!data || !data.token) { closeModal(); return; }

    const t = data.token;
    let html = `
        <div style="margin-bottom:20px;">
            <div style="display:flex; align-items:baseline; gap:12px;">
                <span style="font-family:var(--font-display); font-size:1.2rem; font-weight:600; color:var(--text-primary);">${t.symbol || '???'}</span>
                <span style="color:var(--text-dim); font-size:12px; font-family:var(--font-serif); font-style:italic;">${t.name || ''}</span>
            </div>
            <div class="addr-copy" onclick="copyAddr('${t.mint_address}', event)"
                 style="font-size:11px; word-break:break-all; margin-top:4px; color:var(--text-dim);">
                ${t.mint_address} <span style="font-size:9px;">[click to copy]</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">MARKET CAP</div>
                <div style="font-size:1.1rem; color:var(--text-secondary);">${fmtUsd(t.market_cap_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">PRICE</div>
                <div style="font-size:1.1rem; color:var(--accent-green);">${fmtUsd(t.price_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">LIQUIDITY</div>
                <div style="font-size:1.1rem; color:var(--text-secondary);">${fmtUsd(t.liquidity_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">MULTIPLIER</div>
                <div style="font-size:1.1rem; color:var(--accent-gold); font-weight:600;">
                    ${t.price_multiplier ? t.price_multiplier.toFixed(1) + 'x' : '\u2014'}
                </div>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">VOL 24H</div>
                <div style="color:var(--text-secondary);">${fmtUsd(t.volume_24h_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">HOLDERS</div>
                <div style="color:var(--text-secondary);">${t.holder_count || '\u2014'}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">SOURCE</div>
                <div style="color:var(--accent-amber);">${t.data_source || '\u2014'}</div>
            </div>
        </div>
    `;

    if (data.wallet_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                WALLETS THAT TRADED (${data.wallet_trades.length})
            </div>
            <div class="table-responsive" style="margin-bottom:20px;">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Wallet</th><th>Score</th><th>Buy SOL</th><th>PnL</th><th>Entry Rank</th><th>Status</th>
                    </tr></thead>
                    <tbody>
                        ${data.wallet_trades.map(wt => `
                        <tr>
                            <td class="addr">${shortAddr(wt.wallet_address)}</td>
                            <td><span style="color:${scoreColor(wt.total_score || 0)}">${wt.total_score ? wt.total_score.toFixed(0) : '\u2014'}</span></td>
                            <td>${fmt(wt.buy_amount_sol, 4)}</td>
                            <td>${fmtPnl(wt.pnl_sol)}</td>
                            <td>${wt.entry_rank || '\u2014'}</td>
                            <td>${wt.is_monitored ? '<span class="badge badge-monitored">MON</span>' : ''}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    if (data.copy_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TRADES (${data.copy_trades.length})
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Side</th><th>SOL</th><th>Price</th><th>Wallet</th><th>Status</th><th>Time</th>
                    </tr></thead>
                    <tbody>
                        ${data.copy_trades.map(ct => `
                        <tr>
                            <td><span class="badge badge-${ct.side}">${ct.side.toUpperCase()}</span></td>
                            <td>${fmt(ct.amount_sol, 6)}</td>
                            <td>${fmtUsd(ct.price_usd)}</td>
                            <td class="addr">${shortAddr(ct.triggered_by_wallet)}</td>
                            <td>${ct.status}</td>
                            <td style="white-space:nowrap">${ct.created_at || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    showModal('Token \u2014 ' + (t.symbol || shortAddr(t.mint_address)), html);
}

// =========================================================================
// Chart Instances
// =========================================================================
let pnlChart = null;
let winLossChart = null;
let tradeActivityChart = null;
let portfolioChart = null;

function destroyChart(chart) {
    if (chart) chart.destroy();
    return null;
}

// =========================================================================
// Chart: PnL
// =========================================================================
async function loadPnlChart() {
    const data = await fetchApi('/api/daily_pnl');
    const canvas = document.getElementById('pnlChart');
    if (!canvas || !data) return;

    pnlChart = destroyChart(pnlChart);
    const days = data.daily_pnl;
    if (days.length === 0) return;

    let cumulative = 0;
    const cumulativeData = days.map(d => { cumulative += d.total_pnl_sol; return cumulative; });

    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(184, 150, 12, 0.15)');
    gradient.addColorStop(1, 'rgba(184, 150, 12, 0)');

    pnlChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: days.map(d => d.date),
            datasets: [
                {
                    label: 'Daily PnL (SOL)',
                    data: days.map(d => d.total_pnl_sol),
                    borderColor: '#b8960c',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#b8960c',
                    pointBorderColor: '#b8960c',
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    tension: 0.3,
                    fill: true,
                },
                {
                    label: 'Cumulative PnL (SOL)',
                    data: cumulativeData,
                    borderColor: '#2d6b3f',
                    backgroundColor: 'rgba(45,107,63,0.05)',
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.3,
                    fill: true,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#8a8070', font: { size: 11 } } }
            },
            scales: {
                x: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } },
                y: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } }
            }
        }
    });
}

// =========================================================================
// Chart: Win/Loss Donut
// =========================================================================
function loadWinLossChart(stats) {
    const canvas = document.getElementById('winLossChart');
    if (!canvas || !stats) return;

    winLossChart = destroyChart(winLossChart);
    const wl = stats.win_loss;
    const total = wl.wins + wl.losses;

    winLossChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: ['Wins', 'Losses'],
            datasets: [{
                data: [wl.wins || 0, wl.losses || 0],
                backgroundColor: ['rgba(45,107,63,0.6)', 'rgba(139,44,44,0.6)'],
                borderColor: ['#2d6b3f', '#8b2c2c'],
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Win / Loss', color: '#5a5348', font: { size: 11 } }
            }
        },
        plugins: [{
            id: 'centerText',
            afterDraw(chart) {
                const { ctx, width, height } = chart;
                const rate = total > 0 ? ((wl.wins / total) * 100).toFixed(0) : '0';
                ctx.save();
                ctx.font = "600 22px 'Cormorant Garamond', serif";
                ctx.fillStyle = '#2d6b3f';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(rate + '%', width / 2, height / 2);
                ctx.restore();
            }
        }]
    });
}

// =========================================================================
// Chart: Trade Activity Timeline
// =========================================================================
function loadTradeActivityChart(stats) {
    const canvas = document.getElementById('tradeActivityChart');
    if (!canvas || !stats) return;

    tradeActivityChart = destroyChart(tradeActivityChart);
    const days = stats.daily_activity;
    if (days.length === 0) return;

    tradeActivityChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: days.map(d => d.date),
            datasets: [
                {
                    label: 'Buys',
                    data: days.map(d => d.buys),
                    backgroundColor: 'rgba(45,107,63,0.4)',
                    borderColor: '#2d6b3f',
                    borderWidth: 1,
                    borderRadius: 2,
                },
                {
                    label: 'Sells',
                    data: days.map(d => d.sells),
                    backgroundColor: 'rgba(139,105,20,0.4)',
                    borderColor: '#8b6914',
                    borderWidth: 1,
                    borderRadius: 2,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#8a8070', font: { size: 10 } } },
                title: { display: true, text: 'Trade Activity (30D)', color: '#5a5348', font: { size: 11 } }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#8a8070' }, grid: { display: false } },
                y: { stacked: true, ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' }, beginAtZero: true }
            }
        }
    });
}

// =========================================================================
// Chart: Portfolio Allocation
// =========================================================================
function loadPortfolioChart(stats) {
    const canvas = document.getElementById('portfolioChart');
    if (!canvas || !stats) return;

    portfolioChart = destroyChart(portfolioChart);
    const alloc = stats.portfolio_allocation;
    if (alloc.length === 0) return;

    const palette = ['#b8960c', '#2d6b3f', '#8b6914', '#5a7d6a', '#c4a84d', '#3d8b5c', '#a68a3c'];

    portfolioChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: alloc.map(a => a.token_symbol),
            datasets: [{
                data: alloc.map(a => a.amount_sol),
                backgroundColor: alloc.map((_, i) => (palette[i % palette.length]) + '60'),
                borderColor: alloc.map((_, i) => palette[i % palette.length]),
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            cutout: '60%',
            plugins: {
                legend: { position: 'right', labels: { color: '#8a8070', font: { size: 10 }, padding: 8 } },
                title: { display: true, text: 'Portfolio', color: '#5a5348', font: { size: 11 } }
            }
        }
    });
}

// =========================================================================
// Tab Loaders
// =========================================================================
async function loadTab(name) {
    switch (name) {
        case 'command': return loadCommandCenter();
        case 'smart-money': return loadSmartMoney();
        case 'live-feed': return loadLiveFeed();
        case 'journal': return loadJournal();
        case 'fomo': return loadFomoTraders();
        case 'agent': return loadAgentBrain();
    }
}

// Source badge renderer
function renderSourceBadge(source) {
    const map = {
        'fomo': {cls: 'badge-source-fomo', text: 'FOMO'},
        'gmgn': {cls: 'badge-source-gmgn', text: 'GMGN'},
        'manual': {cls: 'badge-source-manual', text: 'MANUAL'},
        'cluster': {cls: 'badge-source-manual', text: 'CLUSTER'},
    };
    const m = map[source] || map['manual'];
    return `<span class="badge-source ${m.cls}">${m.text}</span>`;
}

// Profit indicator dot
function profitDot(pnl) {
    if (pnl === null || pnl === undefined) return '<span class="profit-indicator no-data" title="No copy trades yet"></span>';
    return pnl > 0
        ? `<span class="profit-indicator profitable" title="+${Number(pnl).toFixed(4)} SOL"></span>`
        : `<span class="profit-indicator unprofitable" title="${Number(pnl).toFixed(4)} SOL"></span>`;
}

// Toggle copy (monitored) status
async function toggleCopy(address, event) {
    if (event) event.stopPropagation();
    try {
        const res = await fetch('/api/wallet/' + encodeURIComponent(address) + '/toggle_monitor', { method: 'POST' });
        if (res.ok) {
            const data = await res.json();
            // Update button in-place
            const btn = event ? event.target.closest('.btn-toggle-copy') : null;
            if (btn) {
                btn.classList.toggle('active', data.is_monitored);
                btn.textContent = data.is_monitored ? 'COPYING' : 'COPY';
            }
        }
    } catch (e) { console.error('Toggle failed:', e); }
}

// Toggle side wallets expand/collapse
function toggleSideWallets(address) {
    const section = document.getElementById('side-' + address);
    const chevron = document.getElementById('chev-' + address);
    if (section) section.classList.toggle('expanded');
    if (chevron) chevron.classList.toggle('open');
}

// =========================================================================
// COMMAND CENTER TAB
// =========================================================================
async function loadCommandCenter() {
    const [data, tradeStats] = await Promise.all([
        fetchApi('/api/command_center'),
        fetchApi('/api/trade_stats'),
    ]);

    if (!data) return;

    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const modeEl = document.getElementById('mode-badge');

    if (data.trading_paused) {
        statusText.textContent = 'Paused';
        statusText.style.color = 'var(--accent-amber)';
        statusDot.classList.add('pulse-dot-amber');
    } else {
        statusText.textContent = 'System Online';
        statusText.style.color = 'var(--accent-green)';
        statusDot.classList.remove('pulse-dot-amber');
    }

    const mode = data.trading_mode.toUpperCase();
    if (mode === 'LIVE') {
        modeEl.textContent = 'Live Trading';
        modeEl.style.color = 'var(--accent-red)';
    } else if (mode === 'DRY_RUN') {
        modeEl.textContent = 'Dry Run';
        modeEl.style.color = 'var(--accent-amber)';
    } else {
        modeEl.textContent = 'Alert Only';
        modeEl.style.color = 'var(--text-dim)';
    }

    const pnl = data.pnl;
    const stats = data.stats;
    const positions = data.active_positions;
    const signals = data.recent_signals;

    const el = document.getElementById('tab-command');
    el.innerHTML = `
        <!-- PnL Hero -->
        <div class="rome-card mb-3 fade-up">
            <div class="card-body-inner pnl-hero">
                <div style="font-family:var(--font-display); font-size:9px; letter-spacing:3px; color:var(--text-dim); margin-bottom:8px;">ALL-TIME REALIZED PnL</div>
                <div class="pnl-main">${fmtPnl(pnl.all_time)}</div>
                <div class="pnl-period-row">
                    <div>
                        <div style="font-family:var(--font-display); font-size:8px; letter-spacing:2px; color:var(--text-dim);">TODAY</div>
                        <div style="font-family:var(--font-serif); font-size:1.3rem; font-weight:600;">${fmtPnl(pnl.today)}</div>
                    </div>
                    <div>
                        <div style="font-family:var(--font-display); font-size:8px; letter-spacing:2px; color:var(--text-dim);">7 DAYS</div>
                        <div style="font-family:var(--font-serif); font-size:1.3rem; font-weight:600;">${fmtPnl(pnl['7d'])}</div>
                    </div>
                    <div>
                        <div style="font-family:var(--font-display); font-size:8px; letter-spacing:2px; color:var(--text-dim);">30 DAYS</div>
                        <div style="font-family:var(--font-serif); font-size:1.3rem; font-weight:600;">${fmtPnl(pnl['30d'])}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-3 mb-3">
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Invested</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmt(stats.total_invested, 4)}</div>
                        <div class="stat-label">SOL Deployed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Win Rate</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" style="color:${stats.win_rate >= 50 ? 'var(--accent-green)' : 'var(--text-dim)'};">${stats.win_rate > 0 ? stats.win_rate + '%' : '\u2014'}</div>
                        <div class="stat-label">Our Accuracy</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Best Trade</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmtPnl(stats.best_trade)}</div>
                        <div class="stat-label">Top Win</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Worst Trade</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmtPnl(stats.worst_trade)}</div>
                        <div class="stat-label">Biggest Loss</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Positions -->
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome">
                <span class="title-text">Active Positions</span>
                <span class="count-text">${positions.length} open</span>
            </div>
            <div class="card-body-inner">
                ${positions.length > 0 ? `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Token</th><th>Invested</th><th>Entry</th><th>Current</th>
                            <th>Multiple</th><th>Unrealized PnL</th><th>Triggered By</th>
                        </tr></thead>
                        <tbody>
                            ${positions.map(p => `
                            <tr>
                                <td><span style="cursor:pointer; color:var(--accent-gold);" onclick="showTokenDetail('${p.token_mint}')"><strong>${p.token_symbol || shortAddr(p.token_mint)}</strong></span></td>
                                <td>${fmt(p.amount_sol_invested, 4)} SOL</td>
                                <td>${fmtUsd(p.entry_price_usd)}</td>
                                <td>${fmtUsd(p.current_price_usd)}</td>
                                <td>${p.multiplier ? `<strong style="color:${p.multiplier >= 1 ? 'var(--accent-green)' : 'var(--accent-red)'};">${p.multiplier}x</strong>` : '\u2014'}</td>
                                <td>${fmtPnl(p.unrealized_pnl_sol)}</td>
                                <td><span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${p.triggered_by_wallet}')">${shortAddr(p.triggered_by_wallet)}</span></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>` : '<div style="color:var(--text-dim); text-align:center; padding:20px; font-style:italic;">No open positions</div>'}
            </div>
        </div>

        <!-- Recent Signals -->
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome">
                <span class="title-text">Recent Signals</span>
                <span class="count-text">${signals.length} latest</span>
            </div>
            <div class="card-body-inner">
                ${signals.length > 0 ? `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Time</th><th>Wallet</th><th>Token</th><th>Type</th><th>Status</th></tr></thead>
                        <tbody>
                            ${signals.map(s => {
                                const status = s.executed ? '<span style="color:var(--accent-green); font-weight:600;">Copied</span>'
                                    : s.skip_reason ? '<span style="color:var(--accent-red);">Skipped: ' + s.skip_reason + '</span>'
                                    : '<span style="color:var(--accent-amber);">Pending</span>';
                                return `<tr>
                                    <td style="white-space:nowrap; color:var(--text-dim);">${s.created_at ? s.created_at.split('T').pop().split('.')[0] : '\u2014'}</td>
                                    <td><span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${s.wallet_address}')">${shortAddr(s.wallet_address)}</span> <span style="color:${scoreColor(s.wallet_total_score || 0)}; font-size:10px;">${s.wallet_total_score ? s.wallet_total_score.toFixed(0) : ''}</span></td>
                                    <td style="color:var(--accent-gold);">${s.token_symbol || shortAddr(s.token_mint)}</td>
                                    <td><span class="badge badge-${s.signal_type === 'sell' ? 'sell' : 'buy'}">${(s.signal_type || 'buy').toUpperCase()}</span></td>
                                    <td>${status}</td>
                                </tr>`;}).join('')}
                        </tbody>
                    </table>
                </div>` : '<div style="color:var(--text-dim); text-align:center; padding:20px; font-style:italic;">Awaiting signals... Run <code>python main.py --monitor</code></div>'}
            </div>
        </div>

        <!-- PnL Chart -->
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome"><span class="title-text">PnL Chart</span></div>
            <div class="chart-container"><canvas id="pnlChart"></canvas></div>
        </div>

        <!-- Analytics Row -->
        <div class="row g-3 mb-3">
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Win / Loss</span></div>
                    <div class="chart-container"><canvas id="winLossChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Trade Activity</span></div>
                    <div class="chart-container"><canvas id="tradeActivityChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Portfolio</span></div>
                    <div class="chart-container"><canvas id="portfolioChart"></canvas></div>
                </div>
            </div>
        </div>
    `;

    loadPnlChart();
    if (tradeStats) {
        loadWinLossChart(tradeStats);
        loadTradeActivityChart(tradeStats);
        loadPortfolioChart(tradeStats);
    }
    updateRefreshTimer();
}

// =========================================================================
// SMART MONEY TAB — Wallet cards with nested side wallets
// =========================================================================
async function loadSmartMoney() {
    const data = await fetchApi('/api/smart_money');
    const el = document.getElementById('tab-smart-money');
    if (!data) return;

    if (data.wallets.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No Smart Money Found</h5>
            <p style="margin-top:12px;">Run discovery + analysis first:</p>
            <code>python main.py --discover</code><br><br>
            <code>python main.py --analyze</code>
        </div>`;
        return;
    }

    let html = `
        <div class="row g-3 mb-3">
            <div class="col-md-4 col-6 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value" style="color:var(--accent-gold);">${data.total_monitored}</div>
                    <div class="stat-label">Copying</div>
                </div></div>
            </div>
            <div class="col-md-4 col-6 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value" style="color:var(--text-secondary);">${data.total_clusters}</div>
                    <div class="stat-label">Clusters Found</div>
                </div></div>
            </div>
            <div class="col-md-4 col-12 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value" style="color:var(--accent-amber);">${data.total_side_wallets}</div>
                    <div class="stat-label">Side Wallets</div>
                </div></div>
            </div>
        </div>
    `;

    data.wallets.forEach((w, i) => {
        // Use GMGN winrate (0-1 decimal) if available, else fall back to local win_rate (0-100)
        const wrRaw = w.gmgn_winrate != null ? w.gmgn_winrate * 100 : (w.win_rate || 0);
        const wr = wrRaw;
        const wrColor = wr >= 60 ? 'var(--accent-green)' : wr >= 40 ? '#8b6914' : 'var(--text-dim)';
        const cluster = w.cluster;
        const sideWallets = cluster ? (cluster.side_wallets || []) : [];
        const hasSideWallets = sideWallets.length > 0;

        html += `
        <div class="smart-money-card fade-up" style="margin-bottom:10px;">
            <!-- Main Row -->
            <div style="padding:14px 16px; display:flex; align-items:center; gap:12px; cursor:pointer; flex-wrap:wrap;"
                 onclick="${hasSideWallets ? "toggleSideWallets('" + w.address + "')" : "showWalletDetail('" + w.address + "')"}">
                <!-- Rank -->
                <div style="font-family:var(--font-serif); font-size:1.3rem; font-weight:600; color:var(--text-dim); min-width:28px; text-align:center;">${i + 1}</div>
                <!-- Address + Source -->
                <div style="min-width:120px; flex:1;">
                    <div>
                        ${w.is_monitored ? '<span class="pulse-dot"></span>' : ''}
                        <span class="addr" style="cursor:pointer;" onclick="event.stopPropagation(); showWalletDetail('${w.address}')">${shortAddr(w.address)}</span>
                        ${hasSideWallets ? '<span class="expand-chevron' + '" id="chev-' + w.address + '">\u25B6</span>' : ''}
                    </div>
                    <div style="margin-top:3px;">${renderSourceBadge(w.source || 'manual')} ${renderTags(w.gmgn_tags)}</div>
                </div>
                <!-- 30D Profit -->
                <div style="text-align:center; min-width:80px;">
                    <div style="font-family:var(--font-display); font-size:8px; letter-spacing:1px; color:var(--text-dim);">30D PROFIT</div>
                    <div style="font-size:13px; font-weight:600;">${fmtProfit(w.gmgn_profit_30d_usd)}</div>
                </div>
                <!-- Win Rate -->
                <div style="text-align:center; min-width:60px;">
                    <div style="font-family:var(--font-display); font-size:8px; letter-spacing:1px; color:var(--text-dim);">WIN RATE</div>
                    <div style="font-size:13px; font-weight:600; color:${wrColor};">${wr > 0 ? wr.toFixed(0) + '%' : '\u2014'}</div>
                </div>
                <!-- Score -->
                <div style="text-align:center; min-width:60px;">
                    <div style="font-family:var(--font-display); font-size:8px; letter-spacing:1px; color:var(--text-dim);">SCORE</div>
                    <div style="font-size:13px; font-weight:600; color:${scoreColor(w.total_score)};">${w.total_score.toFixed(0)}</div>
                    <div class="score-bar" style="margin-top:3px;"><div class="score-fill" style="width:${w.total_score}%; background:${scoreColor(w.total_score)};"></div></div>
                </div>
                <!-- Our PnL -->
                <div style="text-align:center; min-width:70px;">
                    <div style="font-family:var(--font-display); font-size:8px; letter-spacing:1px; color:var(--text-dim);">OUR PnL</div>
                    <div style="font-size:12px;">${profitDot(w.our_copy_pnl_sol)} ${w.our_copy_pnl_sol !== null ? fmtPnl(w.our_copy_pnl_sol) : '<span style="color:var(--text-dim); font-size:11px;">\u2014</span>'}</div>
                </div>
                <!-- Copy Toggle -->
                <div style="min-width:60px; text-align:center;" onclick="event.stopPropagation();">
                    <button class="btn-toggle-copy ${w.is_monitored ? 'active' : ''}" onclick="toggleCopy('${w.address}', event)">
                        ${w.is_monitored ? 'COPYING' : 'COPY'}
                    </button>
                </div>
            </div>

            <!-- Side Wallets Section (collapsed) -->
            ${hasSideWallets ? `
            <div class="side-wallets-section" id="side-${w.address}">
                <div style="font-family:var(--font-display); font-size:9px; letter-spacing:2px; color:var(--text-dim); margin-bottom:8px; padding-bottom:4px; border-bottom:1px solid var(--border-light);">
                    SIDE WALLETS (${sideWallets.length}) \u2014 Cluster Detection
                </div>
                ${sideWallets.map(sw => {
                    const conf = ((sw.confidence || 0) * 100).toFixed(0);
                    const confColor = sw.confidence >= 0.7 ? 'var(--accent-green)' : sw.confidence >= 0.4 ? 'var(--accent-amber)' : 'var(--text-dim)';
                    const leadMin = sw.avg_lead_time_seconds ? (sw.avg_lead_time_seconds / 60).toFixed(1) : '?';
                    return `
                    <div class="side-wallet-row">
                        <div style="color:var(--accent-gold); font-size:10px;">\u25B8</div>
                        <div>
                            <span class="addr" style="cursor:pointer; font-size:11px;" onclick="showWalletDetail('${sw.wallet_address}')">${shortAddr(sw.wallet_address)}</span>
                            ${sw.is_monitored ? '<span class="badge badge-monitored" style="font-size:7px; padding:1px 4px;">MON</span>' : ''}
                        </div>
                        <div style="text-align:center;"><span style="color:${confColor}; font-weight:600;">${conf}%</span> <span style="color:var(--text-dim); font-size:9px;">conf</span></div>
                        <div style="text-align:center; color:var(--accent-green);">${leadMin}m <span style="color:var(--text-dim); font-size:9px;">lead</span></div>
                        <div style="text-align:center; color:${scoreColor(sw.total_score || 0)};">${sw.total_score ? sw.total_score.toFixed(0) : '\u2014'}</div>
                    </div>`;
                }).join('')}
            </div>` : ''}
        </div>`;
    });

    el.innerHTML = html;
    updateRefreshTimer();
}

// =========================================================================
// LIVE FEED TAB — Real-time signal stream
// =========================================================================
async function loadLiveFeed() {
    const data = await fetchApi('/api/signals');
    const el = document.getElementById('tab-live-feed');
    if (!data) return;

    let html = `
        <div class="row g-3 mb-3">
            <div class="col-md-4 col-4 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value">${data.today_total}</div>
                    <div class="stat-label">Signals Today</div>
                </div></div>
            </div>
            <div class="col-md-4 col-4 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value" style="color:var(--accent-green);">${data.today_copied}</div>
                    <div class="stat-label">Copied</div>
                </div></div>
            </div>
            <div class="col-md-4 col-4 fade-up">
                <div class="rome-card"><div class="card-body-inner text-center" style="padding:16px;">
                    <div class="stat-value" style="color:var(--accent-red);">${data.today_skipped}</div>
                    <div class="stat-label">Skipped</div>
                </div></div>
            </div>
        </div>
    `;

    if (data.signals.length === 0) {
        html += `<div class="rome-card fade-up">
            <div class="card-header-rome"><span class="title-text">Signal Feed</span></div>
            <div class="card-body-inner" style="text-align:center; padding:40px;">
                <div style="font-family:var(--font-serif); font-size:16px; font-style:italic; color:var(--text-dim);">
                    Awaiting signals...<br>
                    <span style="font-size:12px; font-family:var(--font-body);">Run <code style="color:var(--accent-gold); background:var(--bg-secondary); padding:2px 6px; border-radius:3px;">python main.py --monitor</code> to start watching wallets</span>
                </div>
            </div>
        </div>`;
    } else {
        html += `<div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Signal Feed</span>
                <span class="count-text">${data.signals.length} signals</span>
            </div>
            <div class="card-body-inner" style="padding:0;">
                ${data.signals.map(s => {
                    const status = s.executed
                        ? '<span style="color:var(--accent-green); font-weight:600; font-size:11px;">COPIED</span>'
                        : s.skip_reason
                            ? '<span style="color:var(--accent-red); font-size:11px;">SKIP: ' + s.skip_reason + '</span>'
                            : '<span style="color:var(--accent-amber); font-size:11px;">PENDING</span>';
                    const time = s.created_at ? s.created_at.split('T').pop().split('.')[0] : '\u2014';
                    const walletTags = s.wallet_tags || [];
                    return `
                    <div class="signal-row">
                        <div style="color:var(--text-dim); font-size:11px; white-space:nowrap;">${time}</div>
                        <div>
                            <span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${s.wallet_address}')">${shortAddr(s.wallet_address)}</span>
                            <span style="color:${scoreColor(s.wallet_total_score || 0)}; font-size:10px; font-weight:600; margin-left:4px;">${s.wallet_total_score ? s.wallet_total_score.toFixed(0) : ''}</span>
                            ${renderTags(walletTags.slice(0, 2))}
                        </div>
                        <div>
                            <span style="color:var(--accent-gold); font-weight:500;">${s.token_symbol || shortAddr(s.token_mint)}</span>
                            <span class="badge badge-${s.signal_type === 'sell' ? 'sell' : 'buy'}" style="margin-left:4px;">${(s.signal_type || 'buy').toUpperCase()}</span>
                        </div>
                        <div style="text-align:right;">${status}</div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }

    el.innerHTML = html;
    updateRefreshTimer();
}

// =========================================================================
// JOURNAL TAB — Trade history grouped by wallet + performance
// =========================================================================
let journalPnlChart = null;

async function loadJournal() {
    const data = await fetchApi('/api/journal');
    const el = document.getElementById('tab-journal');
    if (!data) return;

    let html = '';

    // PnL Chart
    html += `
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome"><span class="title-text">PnL History</span></div>
            <div class="chart-container"><canvas id="journalPnlChart"></canvas></div>
        </div>
    `;

    // Performance by Wallet
    if (data.wallet_performance.length > 0) {
        html += `
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome">
                <span class="title-text">Copy Performance by Wallet</span>
                <span class="count-text">${data.wallet_performance.length} wallets</span>
            </div>
            <div class="card-body-inner">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Wallet</th><th>Trades</th><th>Buys</th><th>Sells</th><th>Net PnL</th><th>Profitable?</th>
                        </tr></thead>
                        <tbody>
                            ${data.wallet_performance.map(wp => `
                            <tr onclick="showWalletDetail('${wp.triggered_by_wallet}')">
                                <td><span class="addr">${shortAddr(wp.triggered_by_wallet)}</span></td>
                                <td>${wp.total_trades}</td>
                                <td>${wp.buys}</td>
                                <td>${wp.sells}</td>
                                <td>${fmtPnl(wp.net_pnl)}</td>
                                <td>${wp.net_pnl > 0 ? '<span style="color:var(--accent-green); font-weight:600;">\u2713</span>' : '<span style="color:var(--accent-red);">\u2717</span>'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
    }

    // Full Trade Journal
    if (data.trades.length > 0) {
        html += `
        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Trade Journal</span>
                <span class="count-text">${data.trades.length} entries</span>
            </div>
            <div class="card-body-inner">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Time</th><th>Token</th><th>Side</th><th>SOL</th><th>Wallet</th><th>Score</th><th>Status</th>
                        </tr></thead>
                        <tbody>
                            ${data.trades.map(t => `
                            <tr>
                                <td style="white-space:nowrap; color:var(--text-dim);">${t.created_at ? t.created_at.split('T').pop().split('.')[0] : '\u2014'}</td>
                                <td><span style="color:var(--accent-gold); cursor:pointer;" onclick="showTokenDetail('${t.token_mint}')">${t.token_symbol || shortAddr(t.token_mint)}</span></td>
                                <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                                <td>${fmt(t.amount_sol, 6)}</td>
                                <td><span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${t.triggered_by_wallet}')">${shortAddr(t.triggered_by_wallet)}</span></td>
                                <td style="color:${scoreColor(t.wallet_score || 0)};">${t.wallet_score ? t.wallet_score.toFixed(0) : '\u2014'}</td>
                                <td>${t.status}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
    } else {
        html += `<div class="rome-card fade-up">
            <div class="card-header-rome"><span class="title-text">Trade Journal</span></div>
            <div class="card-body-inner" style="text-align:center; padding:40px;">
                <div style="font-family:var(--font-serif); font-size:16px; font-style:italic; color:var(--text-dim);">
                    No trades executed yet. Journal will populate once copy trading begins.
                </div>
            </div>
        </div>`;
    }

    el.innerHTML = html;

    // Render PnL chart for journal
    if (data.daily_pnl && data.daily_pnl.length > 0) {
        journalPnlChart = destroyChart(journalPnlChart);
        const canvas = document.getElementById('journalPnlChart');
        if (canvas) {
            const days = data.daily_pnl;
            let cumulative = 0;
            const cumulativeData = days.map(d => { cumulative += d.total_pnl_sol; return cumulative; });
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(184, 150, 12, 0.15)');
            gradient.addColorStop(1, 'rgba(184, 150, 12, 0)');
            journalPnlChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: days.map(d => d.date),
                    datasets: [
                        { label: 'Daily PnL', data: days.map(d => d.total_pnl_sol), borderColor: '#b8960c', backgroundColor: gradient, borderWidth: 2, pointRadius: 3, tension: 0.3, fill: true },
                        { label: 'Cumulative', data: cumulativeData, borderColor: '#2d6b3f', backgroundColor: 'rgba(45,107,63,0.05)', borderWidth: 2, pointRadius: 2, tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#8a8070', font: { size: 11 } } } },
                    scales: {
                        x: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } },
                        y: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } }
                    }
                }
            });
        }
    }
    updateRefreshTimer();
}

// =========================================================================
// FOMO Traders Tab
// =========================================================================
async function loadFomoTraders() {
    const data = await fetchApi('/api/fomo_traders');
    const el = document.getElementById('tab-fomo');
    if (!data) {
        el.innerHTML = '<div class="card-roman p-4 text-center" style="color:var(--text-dim)">Failed to load FOMO data</div>';
        return;
    }

    const traders = data.traders || [];

    let html = `
    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card-roman p-3 text-center">
            <div style="font-size:28px; font-family:var(--font-display); color:var(--accent-gold)">${traders.length}</div>
            <div class="stat-label">Tracked Traders</div>
        </div></div>
        <div class="col-md-3"><div class="card-roman p-3 text-center">
            <div style="font-size:28px; font-family:var(--font-display); color:var(--accent-green)">${traders.filter(t => t.is_monitored).length}</div>
            <div class="stat-label">Monitored</div>
        </div></div>
        <div class="col-md-3"><div class="card-roman p-3 text-center">
            <div style="font-size:28px; font-family:var(--font-display); color:var(--accent-gold)">$${traders.reduce((s,t) => s + (t.pnl_24h_usd || 0), 0).toLocaleString(undefined, {maximumFractionDigits:0})}</div>
            <div class="stat-label">Combined 24h PnL</div>
        </div></div>
        <div class="col-md-3"><div class="card-roman p-3 text-center">
            <div style="font-size:28px; font-family:var(--font-display); color:var(--accent-gold)">$${traders.reduce((s,t) => s + (t.pnl_30d_usd || 0), 0).toLocaleString(undefined, {maximumFractionDigits:0})}</div>
            <div class="stat-label">Combined 30d PnL</div>
        </div></div>
    </div>

    <div class="card-roman p-3 mb-3">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
            <h6 style="font-family:var(--font-display); color:var(--accent-gold); margin:0; letter-spacing:1px">FOMO LEADERBOARD TRADERS</h6>
            <span class="badge" style="background:var(--bg-secondary); color:var(--text-dim); font-size:11px">Add via CLI: --add-fomo-wallet</span>
        </div>`;

    if (traders.length === 0) {
        html += `
        <div class="text-center py-5" style="color:var(--text-dim)">
            <div style="font-size:48px; margin-bottom:12px; opacity:0.3">&#9776;</div>
            <p style="font-family:var(--font-serif); font-size:16px">No FOMO traders tracked yet</p>
            <p style="font-size:12px">Add wallet addresses from the FOMO leaderboard:</p>
            <code style="background:var(--bg-secondary); padding:6px 12px; border-radius:4px; font-size:12px">python main.py --add-fomo-wallet &lt;address&gt;</code>
        </div>`;
    } else {
        html += `<div class="table-responsive"><table class="table-roman"><thead><tr>
            <th style="width:40px">#</th><th>Wallet</th><th>Name</th><th>Twitter</th>
            <th class="text-end">24h PnL</th><th class="text-end">30d PnL</th>
            <th class="text-end">GMGN Profit</th><th class="text-end">Win Rate</th>
            <th>Tags</th><th class="text-center">Status</th>
        </tr></thead><tbody>`;

        traders.forEach((t, i) => {
            const addr = t.wallet_address || '';
            const short = addr ? addr.slice(0,6)+'...'+addr.slice(-4) : '\u2014';
            const name = t.username || '\u2014';
            const tw = t.twitter_handle ? '@'+t.twitter_handle.replace('@','') : '\u2014';
            const p24 = t.pnl_24h_usd || 0;
            const p30 = t.pnl_30d_usd || 0;
            const gp = t.gmgn_profit_30d || 0;
            const wr = t.gmgn_winrate != null ? (t.gmgn_winrate*100).toFixed(0)+'%' : '\u2014';
            const tags = Array.isArray(t.gmgn_tags) ? t.gmgn_tags : [];
            const rank = t.ranking || (i+1);
            const c24 = p24 >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const c30 = p30 >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const cg = gp >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

            html += `<tr>
                <td style="font-family:var(--font-display);color:var(--accent-gold)">${rank}</td>
                <td><span class="addr-copy" onclick="navigator.clipboard.writeText('${addr}')" title="Click to copy" style="cursor:pointer;font-family:monospace;font-size:12px">${short}</span></td>
                <td style="font-family:var(--font-serif);font-weight:600">${name}</td>
                <td style="font-size:12px;color:var(--text-dim)">${tw}</td>
                <td class="text-end" style="color:${c24};font-weight:500">$${p24.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                <td class="text-end" style="color:${c30};font-weight:500">$${p30.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                <td class="text-end" style="color:${cg};font-weight:500">$${gp.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                <td class="text-end">${wr}</td>
                <td>${tags.slice(0,3).map(x => '<span class="badge" style="background:var(--bg-secondary);color:var(--text-dim);font-size:10px;margin-right:2px">'+x+'</span>').join('')}</td>
                <td class="text-center">${t.is_monitored ? '<span style="color:var(--accent-green)">&#9679; Live</span>' : '<span style="color:var(--text-dim)">&#9675; Off</span>'}</td>
            </tr>`;
        });
        html += '</tbody></table></div>';
    }
    html += '</div>';
    el.innerHTML = html;
    updateRefreshTimer();
}

// =========================================================================
// Agent Brain Tab
// =========================================================================
async function loadAgentBrain() {
    const data = await fetchApi('/api/agent');
    const el = document.getElementById('tab-agent');
    if (!data) {
        el.innerHTML = '<div class="card-roman p-4 text-center" style="color:var(--text-dim)">Failed to load agent data</div>';
        return;
    }

    const s = data.strategy || {};
    const decisions = data.recent_decisions || [];
    const enabled = data.agent_enabled;
    const totalTrades = (s.wins||0) + (s.losses||0);
    const winRate = totalTrades > 0 ? ((s.wins/totalTrades)*100).toFixed(1) : '0.0';

    let html = `
    <!-- Status Banner -->
    <div class="card-roman p-3 mb-3" style="border-left:3px solid ${enabled ? 'var(--accent-green)' : 'var(--accent-amber)'}">
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">${enabled ? '&#9679;' : '&#9675;'}</span>
            <div>
                <div style="font-family:var(--font-display);font-size:14px;letter-spacing:1px;color:${enabled ? 'var(--accent-green)' : 'var(--accent-amber)'}">
                    AGENT BRAIN ${enabled ? 'ONLINE' : 'STANDBY'}</div>
                <div style="font-size:11px;color:var(--text-dim)">
                    ${enabled ? 'Autonomous mode \u2014 making independent decisions' : 'Enable: AGENT_ENABLED=true in .env, then run --agent'}</div>
            </div>
        </div>
    </div>

    <!-- Strategy Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:var(--accent-gold)">${(s.min_confidence||0.6).toFixed(2)}</div>
            <div class="stat-label">Min Confidence</div>
        </div></div>
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:var(--accent-gold)">${s.consensus_threshold||2}</div>
            <div class="stat-label">Consensus Req</div>
        </div></div>
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:var(--accent-gold)">${(s.position_scale||1.0).toFixed(1)}x</div>
            <div class="stat-label">Position Scale</div>
        </div></div>
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:var(--accent-green)">${winRate}%</div>
            <div class="stat-label">Win Rate</div>
        </div></div>
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:${(s.total_pnl_sol||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${(s.total_pnl_sol||0).toFixed(4)}</div>
            <div class="stat-label">Total PnL (SOL)</div>
        </div></div>
        <div class="col-md-2"><div class="card-roman p-3 text-center">
            <div style="font-size:24px;font-family:var(--font-display);color:var(--accent-gold)">${s.learning_cycles||0}</div>
            <div class="stat-label">Learn Cycles</div>
        </div></div>
    </div>

    <!-- Performance + Learning -->
    <div class="row g-3 mb-4">
        <div class="col-md-6"><div class="card-roman p-3">
            <h6 style="font-family:var(--font-display);color:var(--accent-gold);letter-spacing:1px;margin-bottom:12px">PERFORMANCE</h6>
            <div class="row text-center">
                <div class="col-4"><div style="font-size:20px;font-weight:600;color:var(--accent-green)">${s.wins||0}</div><div class="stat-label">Wins</div></div>
                <div class="col-4"><div style="font-size:20px;font-weight:600;color:var(--accent-red)">${s.losses||0}</div><div class="stat-label">Losses</div></div>
                <div class="col-4"><div style="font-size:20px;font-weight:600;color:var(--text-primary)">${s.total_decisions||0}</div><div class="stat-label">Decisions</div></div>
            </div>
            <hr style="border-color:var(--border-light);margin:12px 0">
            <div class="row text-center">
                <div class="col-4"><div style="font-size:14px;color:var(--accent-green)">${(s.best_trade_sol||0).toFixed(4)}</div><div class="stat-label">Best Trade</div></div>
                <div class="col-4"><div style="font-size:14px;color:var(--accent-red)">${(s.worst_trade_sol||0).toFixed(4)}</div><div class="stat-label">Worst Trade</div></div>
                <div class="col-4"><div style="font-size:14px;color:var(--text-primary)">${s.trusted_wallets||0}</div><div class="stat-label">Trust Adjusted</div></div>
            </div>
        </div></div>
        <div class="col-md-6"><div class="card-roman p-3">
            <h6 style="font-family:var(--font-display);color:var(--accent-gold);letter-spacing:1px;margin-bottom:12px">LEARNING INSIGHTS</h6>
            <div style="font-size:13px;line-height:1.8">
                <div><span style="color:var(--text-dim)">Confidence threshold:</span> <strong>${(s.min_confidence||0.6).toFixed(2)}</strong> <span style="color:var(--text-dim)">(auto-adjusts)</span></div>
                <div><span style="color:var(--text-dim)">Position multiplier:</span> <strong>${(s.position_scale||1.0).toFixed(1)}x</strong> <span style="color:var(--text-dim)">(scales with win rate)</span></div>
                <div><span style="color:var(--text-dim)">Wallets trust-adjusted:</span> <strong>${s.trusted_wallets||0}</strong></div>
                <div><span style="color:var(--text-dim)">Tokens blacklisted:</span> <strong>${s.blacklisted_tokens||0}</strong></div>
                <div><span style="color:var(--text-dim)">Learning cycles:</span> <strong>${s.learning_cycles||0}</strong></div>
            </div>
        </div></div>
    </div>

    <!-- Decision Journal -->
    <div class="card-roman p-3">
        <h6 style="font-family:var(--font-display);color:var(--accent-gold);letter-spacing:1px;margin-bottom:12px">DECISION JOURNAL</h6>`;

    if (decisions.length === 0) {
        html += `<div class="text-center py-4" style="color:var(--text-dim)">
            <p style="font-family:var(--font-serif);font-size:16px">No decisions recorded yet</p>
            <p style="font-size:12px">Run the agent to start logging decisions:</p>
            <code style="background:var(--bg-secondary);padding:6px 12px;border-radius:4px;font-size:12px">python main.py --agent --dry-run</code>
        </div>`;
    } else {
        html += `<div class="table-responsive"><table class="table-roman"><thead><tr>
            <th>Time</th><th>Token</th><th>Decision</th><th class="text-end">Confidence</th>
            <th class="text-end">Wallets</th><th class="text-end">Amount</th><th>Reasons</th><th class="text-end">Outcome</th>
        </tr></thead><tbody>`;

        const dColors = {buy:'var(--accent-green)',sell:'var(--accent-red)',hold:'var(--accent-amber)',skip:'var(--text-dim)'};
        decisions.forEach(d => {
            const time = d.created_at ? new Date(d.created_at).toLocaleString() : '\u2014';
            const sym = d.token_symbol || (d.token_mint?d.token_mint.slice(0,8):'\u2014');
            const dec = d.decision || '\u2014';
            const conf = d.confidence!=null ? (d.confidence*100).toFixed(0)+'%' : '\u2014';
            const wc = d.wallets_buying || 0;
            const amt = d.amount_sol ? d.amount_sol.toFixed(4)+' SOL' : '\u2014';
            const reasons = Array.isArray(d.reasons) ? d.reasons.join(', ') : '\u2014';
            const pnl = d.outcome_pnl_sol;
            const pStr = pnl!=null ? (pnl>=0?'+':'')+pnl.toFixed(4) : '\u2014';
            const pCol = pnl!=null ? (pnl>=0?'var(--accent-green)':'var(--accent-red)') : 'var(--text-dim)';

            html += `<tr>
                <td style="font-size:11px;color:var(--text-dim);white-space:nowrap">${time}</td>
                <td style="font-family:monospace;font-weight:600">${sym}</td>
                <td><span style="color:${dColors[dec]||'var(--text-dim)'};font-weight:600;text-transform:uppercase">${dec}</span></td>
                <td class="text-end">${conf}</td>
                <td class="text-end">${wc}</td>
                <td class="text-end" style="font-family:monospace">${amt}</td>
                <td style="font-size:11px;color:var(--text-dim);max-width:200px;overflow:hidden;text-overflow:ellipsis">${reasons}</td>
                <td class="text-end" style="color:${pCol};font-weight:500">${pStr}</td>
            </tr>`;
        });
        html += '</tbody></table></div>';
    }
    html += '</div>';
    el.innerHTML = html;
    updateRefreshTimer();
}

// =========================================================================
// Audio System — Ambient Music + UI Sounds
// =========================================================================
const AudioSystem = {
    ctx: null,
    musicPlaying: false,
    musicNodes: [],
    initialized: false,

    init() {
        if (this.initialized) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Browsers suspend AudioContext until user gesture — must resume
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
        this.initialized = true;
    },

    // Clock tick — sharp mechanical click like a clock hand advancing
    playClick() {
        if (!this.ctx) this.init();
        const t = this.ctx.currentTime;
        // Sharp attack oscillator — woody clock tick
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1800, t);
        osc.frequency.exponentialRampToValueAtTime(400, t + 0.015);
        gain.gain.setValueAtTime(0.12, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.06);
        // Resonant body — gives it that hollow clock case sound
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 800;
        filter.Q.value = 8;
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start(t);
        osc.stop(t + 0.07);
    },

    // Clock tock — softer, lower companion to the tick (hover)
    playHover() {
        if (!this.ctx) this.init();
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1200, t);
        osc.frequency.exponentialRampToValueAtTime(300, t + 0.012);
        gain.gain.setValueAtTime(0.04, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 600;
        filter.Q.value = 6;
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start(t);
        osc.stop(t + 0.06);
    },

    // Ambient music — plays audio file
    startMusic() {
        if (this.musicPlaying) return;
        this.musicPlaying = true;

        if (!this.audioEl) {
            this.audioEl = new Audio('/static/audio/gloomy.mp3');
            this.audioEl.loop = true;
            this.audioEl.volume = 0.3;
            this.audioEl.preload = 'auto';
        }
        // Resume context first (required after user gesture)
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
        const playPromise = this.audioEl.play();
        if (playPromise) {
            playPromise.catch(err => {
                console.log('Music autoplay blocked:', err.message);
                this.musicPlaying = false;
            });
        }
    },

    stopMusic() {
        this.musicPlaying = false;
        if (this.audioEl) {
            this.audioEl.pause();
        }
    }
};

function toggleMusic() {
    AudioSystem.init();
    if (AudioSystem.musicPlaying) {
        AudioSystem.stopMusic();
        document.getElementById('musicBars').classList.remove('playing');
    } else {
        AudioSystem.startMusic();
        document.getElementById('musicBars').classList.add('playing');
    }
}

// Click sounds on interactive elements
document.addEventListener('click', (e) => {
    const target = e.target.closest('a, button, .addr-copy, [onclick], .table-hover tbody tr, .nav-link');
    if (target && AudioSystem.initialized) {
        AudioSystem.playClick();
    }
});

// Hover sounds on nav links
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('mouseenter', () => {
        if (AudioSystem.initialized) AudioSystem.playHover();
    });
});

// Start music on first interaction (splash page load)
// Browsers require a user gesture before audio can play, so we listen for
// the very first click/touch anywhere and start music immediately
(function initMusicOnFirstInteraction() {
    function startOnInteraction() {
        AudioSystem.init();
        AudioSystem.startMusic();
        document.getElementById('musicBars')?.classList.add('playing');
        document.removeEventListener('click', startOnInteraction);
        document.removeEventListener('touchstart', startOnInteraction);
    }
    document.addEventListener('click', startOnInteraction, { once: true });
    document.addEventListener('touchstart', startOnInteraction, { once: true });
})();

// =========================================================================
// CRT Static Noise — animated TV noise on canvas
// =========================================================================
(function initCRTStatic() {
    const canvas = document.getElementById('crtStatic');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let animId;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    function drawStatic() {
        const w = canvas.width, h = canvas.height;
        const imageData = ctx.createImageData(w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const v = Math.random() * 255;
            data[i] = v;
            data[i + 1] = v;
            data[i + 2] = v;
            data[i + 3] = 255;
        }
        ctx.putImageData(imageData, 0, 0);
        animId = requestAnimationFrame(drawStatic);
    }
    drawStatic();

    // Stop static animation when splash is dismissed
    const observer = new MutationObserver(() => {
        if (document.getElementById('splash')?.classList.contains('hidden')) {
            cancelAnimationFrame(animId);
            observer.disconnect();
        }
    });
    observer.observe(document.getElementById('splash'), { attributes: true });
})();

// =========================================================================
// Subtle parallax on splash bust watermark
// =========================================================================
document.getElementById('splash')?.addEventListener('mousemove', (e) => {
    const bust = document.querySelector('.splash-bg-bust');
    if (!bust) return;
    const x = (e.clientX / window.innerWidth - 0.5) * 6;
    const y = (e.clientY / window.innerHeight - 0.5) * 6;
    bust.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
});

// =========================================================================
// Initial Load & Auto-Refresh
// =========================================================================
loadCommandCenter();
setInterval(() => loadTab(activeTab), 30000);
</script>
</body>
</html>
