<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROME AGENT TRADER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Inter:wght@300;400;500;600&family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        /* ========================================
           CSS CUSTOM PROPERTIES — ROMAN THEME
           ======================================== */
        :root {
            --bg-primary: #f5f0e8;
            --bg-secondary: #ece6d9;
            --bg-card: rgba(255, 253, 247, 0.7);
            --bg-card-hover: rgba(255, 253, 247, 0.9);
            --border-color: #c4b99a;
            --border-light: #d9d0bc;
            --border-gold: #b8960c;
            --text-primary: #2a2520;
            --text-secondary: #5a5348;
            --text-dim: #8a8070;
            --accent-gold: #b8960c;
            --accent-gold-light: #d4af37;
            --accent-green: #2d6b3f;
            --accent-red: #8b2c2c;
            --accent-amber: #8b6914;
            --font-display: 'Cinzel', serif;
            --font-serif: 'Cormorant Garamond', serif;
            --font-body: 'Inter', sans-serif;
            --shadow-card: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-card-hover: 0 4px 20px rgba(0,0,0,0.1);
            --texture: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23f5f0e8'/%3E%3Crect width='1' height='1' fill='%23ede8dd' opacity='0.5'/%3E%3C/svg%3E");
        }

        /* ========================================
           GLOBAL RESET & BODY
           ======================================== */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            background: var(--bg-primary);
            background-image: var(--texture);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 13px;
            line-height: 1.6;
            overflow-x: hidden;
            margin: 0;
        }
        /* Large faint bust outline watermark on dashboard — like Mozaic's helmet */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85vh;
            height: 85vh;
            background: url('/static/images/bust-outline.png') center/contain no-repeat;
            opacity: 0.06;
            pointer-events: none;
            z-index: 0;
        }

        /* ========================================
           SPLASH SCREEN — CRT SURVEILLANCE MONITOR
           ======================================== */
        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            background-image: var(--texture);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            overflow: hidden;
        }
        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Large bust watermark behind everything on splash */
        .splash-bg-bust {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75vh;
            height: 75vh;
            background: url('/static/images/bust-outline.png') center/contain no-repeat;
            opacity: 0.08;
            z-index: 1;
            pointer-events: none;
        }

        /* CRT TV static noise — animated canvas overlay */
        .crt-static {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2;
            opacity: 0.04;
            mix-blend-mode: multiply;
            pointer-events: none;
        }

        /* Horizontal scan lines — subtle on cream */
        .crt-scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 3px,
                rgba(0, 0, 0, 0.03) 3px,
                rgba(0, 0, 0, 0.03) 6px
            );
            z-index: 3;
            pointer-events: none;
            animation: scanlineShift 0.1s steps(2) infinite;
        }

        /* Moving scan bar */
        .crt-scanbar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.02), transparent);
            z-index: 4;
            pointer-events: none;
            animation: scanbar 4s linear infinite;
        }

        /* Subtle vignette flicker */
        .splash-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.08) 100%);
            z-index: 5;
            pointer-events: none;
            animation: crtFlicker 0.15s infinite;
        }

        @keyframes scanlineShift {
            0% { transform: translateY(0); }
            100% { transform: translateY(6px); }
        }
        @keyframes scanbar {
            0% { top: -2%; }
            100% { top: 102%; }
        }
        @keyframes crtFlicker {
            0% { opacity: 1; }
            50% { opacity: 0.97; }
            100% { opacity: 1; }
        }

        /* Title text — "Rome Agent" */
        .splash-title {
            position: relative;
            z-index: 6;
            margin-top: 0;
            font-family: var(--font-display);
            font-size: 18px;
            letter-spacing: 10px;
            color: var(--accent-gold);
            text-transform: uppercase;
            opacity: 0;
            animation: heroFadeIn 2s ease 0.5s forwards;
        }

        /* "Click to enter" prompt */
        .splash-enter {
            position: relative;
            z-index: 6;
            margin-top: 12px;
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 5px;
            color: var(--text-dim);
            text-transform: uppercase;
            opacity: 0;
            animation: heroFadeIn 1.5s ease 1.2s forwards, splashPulse 3s ease 2.5s infinite;
        }

        @keyframes heroFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes splashPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Compass star in corner */
        .compass-star {
            position: fixed;
            top: 24px;
            right: 28px;
            font-size: 18px;
            color: var(--accent-gold);
            opacity: 0.5;
            z-index: 100;
            cursor: default;
        }

        /* ========================================
           SCROLLBAR
           ======================================== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* ========================================
           HEADER BAR
           ======================================== */
        .header-bar {
            background: transparent;
            padding: 24px 0 8px 0;
            margin-bottom: 0;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .brand-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 1.5px solid var(--border-color);
        }
        .brand-name {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 4px;
            color: var(--text-primary);
        }
        .brand-subtitle {
            font-family: var(--font-serif);
            font-size: 12px;
            font-style: italic;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .header-status {
            text-align: right;
            font-family: var(--font-body);
        }

        /* ========================================
           NAVIGATION
           ======================================== */
        .nav-roman {
            display: flex;
            align-items: center;
            gap: 0;
            margin: 16px 0 24px 0;
            padding: 0;
            list-style: none;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 12px;
        }
        .nav-roman .nav-item { position: relative; }
        .nav-roman .nav-link {
            color: var(--text-dim);
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 8px 24px;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
            background: none;
        }
        .nav-roman .nav-link:hover {
            color: var(--text-primary);
        }
        .nav-roman .nav-link.active {
            color: var(--accent-gold);
        }
        .nav-roman .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 24px;
            right: 24px;
            height: 2px;
            background: var(--accent-gold);
        }
        .nav-separator {
            color: var(--border-color);
            font-size: 8px;
            padding: 0 4px;
        }

        /* ========================================
           CARDS — GLASS PARCHMENT
           ======================================== */
        .rome-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-card);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        .rome-card:hover {
            box-shadow: var(--shadow-card-hover);
        }
        .card-header-rome {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header-rome .title-text {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 3px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .card-header-rome .count-text {
            font-family: var(--font-body);
            font-size: 10px;
            color: var(--text-dim);
        }
        .card-body-inner { padding: 20px; }

        /* ========================================
           STAT VALUES & LABELS
           ======================================== */
        .stat-value {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .stat-label {
            font-family: var(--font-display);
            color: var(--text-dim);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }
        .stat-mini {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 14px 16px;
            text-align: center;
        }

        /* ========================================
           PNL COLORS
           ======================================== */
        .pnl-positive { color: var(--accent-green); font-weight: 500; }
        .pnl-negative { color: var(--accent-red); font-weight: 500; }

        /* ========================================
           TABLE STYLES
           ======================================== */
        .table {
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 12px;
            border-collapse: collapse;
            --bs-table-bg: transparent;
            --bs-table-color: var(--text-primary);
            --bs-table-border-color: var(--border-light);
            --bs-table-hover-bg: rgba(184, 150, 12, 0.04);
            --bs-table-hover-color: var(--text-primary);
        }
        .table thead th {
            border-bottom: 1px solid var(--border-color);
            color: var(--text-dim);
            font-family: var(--font-display);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 10px 8px;
            font-weight: 500;
        }
        .table td {
            border-bottom: 1px solid var(--border-light);
            padding: 8px;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover { cursor: pointer; }

        /* ========================================
           BADGES
           ======================================== */
        .badge-buy {
            background: var(--accent-green) !important;
            color: #fff !important;
            font-weight: 500;
            font-size: 10px;
            border-radius: 3px;
        }
        .badge-sell {
            background: var(--accent-amber) !important;
            color: #fff !important;
            font-weight: 500;
            font-size: 10px;
            border-radius: 3px;
        }
        .badge-open {
            background: var(--accent-green) !important;
            color: #fff !important;
            font-size: 10px;
        }
        .badge-closed {
            background: var(--text-dim) !important;
            font-size: 10px;
        }
        .badge-monitored {
            background: transparent !important;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold) !important;
            font-size: 9px;
            letter-spacing: 1px;
        }
        .badge-flagged {
            background: transparent !important;
            border: 1px solid var(--accent-red);
            color: var(--accent-red) !important;
            font-size: 9px;
        }
        .badge-mode-live {
            background: var(--accent-red) !important;
            color: #fff !important;
        }
        .badge-mode-dry {
            background: var(--accent-amber) !important;
            color: #fff !important;
        }
        .badge-mode-alert {
            background: var(--text-dim) !important;
            color: #fff !important;
        }

        /* ========================================
           PULSE DOT
           ======================================== */
        .pulse-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse-breathe 2s ease-in-out infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        .pulse-dot-amber { background: var(--accent-amber); }
        @keyframes pulse-breathe {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ========================================
           SCORE BARS
           ======================================== */
        .score-bar {
            height: 3px;
            background: var(--border-light);
            border-radius: 2px;
            margin-top: 4px;
        }
        .score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* ========================================
           ADDRESS STYLES
           ======================================== */
        .addr {
            font-family: 'Inter', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .addr-copy {
            cursor: pointer;
            border-bottom: 1px dashed var(--border-color);
            transition: color 0.2s;
        }
        .addr-copy:hover { color: var(--accent-gold); }

        /* ========================================
           LOADING & EMPTY STATES
           ======================================== */
        .loading-text {
            color: var(--text-dim);
            text-align: center;
            padding: 40px;
            font-family: var(--font-serif);
            font-size: 16px;
            font-style: italic;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        .empty-state h5 {
            font-family: var(--font-display);
            font-weight: 500;
            letter-spacing: 3px;
            color: var(--text-secondary);
        }
        .empty-state code {
            color: var(--accent-gold);
            background: var(--bg-secondary);
            padding: 3px 10px;
            border: 1px solid var(--border-light);
            border-radius: 3px;
            font-size: 12px;
        }

        /* ========================================
           MODAL
           ======================================== */
        .terminal-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .terminal-modal {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 850px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-titlebar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            border-radius: 12px 12px 0 0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-display);
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 3px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .modal-close {
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-body);
            padding: 4px 12px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: #fff;
        }
        .modal-body-inner { padding: 24px; }

        /* ========================================
           CHART CONTAINERS
           ======================================== */
        .chart-container { position: relative; padding: 16px; }
        .chart-container canvas { max-height: 250px; }
        .chart-small canvas { max-height: 200px; }

        /* ========================================
           TICKER BAR
           ======================================== */
        .ticker-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            overflow: hidden;
            white-space: nowrap;
            height: 32px;
            line-height: 32px;
            font-size: 11px;
            color: var(--text-dim);
            position: relative;
        }
        .ticker-content {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 40s linear infinite;
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* ========================================
           FADE IN ANIMATION
           ======================================== */
        .fade-up {
            opacity: 0;
            transform: translateY(12px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-up:nth-child(2) { animation-delay: 0.05s; }
        .fade-up:nth-child(3) { animation-delay: 0.1s; }
        .fade-up:nth-child(4) { animation-delay: 0.15s; }

        /* ========================================
           CUSTOM CURSOR
           ======================================== */
        body { cursor: default; }
        a, button, .addr-copy, .table-hover tbody tr, [onclick] {
            cursor: pointer;
        }

        /* ========================================
           HOVER LIFT EFFECT ON CARDS
           ======================================== */
        .rome-card {
            transition: box-shadow 0.3s ease, transform 0.25s ease;
        }
        .rome-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-card-hover);
        }

        /* ========================================
           SMOOTH PAGE TRANSITIONS
           ======================================== */
        [id^="tab-"] {
            animation: tabFadeIn 0.4s ease;
        }
        @keyframes tabFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           MUSIC TOGGLE
           ======================================== */
        .music-toggle {
            position: fixed;
            bottom: 24px;
            right: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-card);
        }
        .music-toggle:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }
        .music-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 14px;
        }
        .music-bars .bar {
            width: 3px;
            background: var(--accent-gold);
            border-radius: 1px;
            transition: height 0.2s ease;
        }
        .music-bars.playing .bar:nth-child(1) { animation: musicBar 0.8s ease infinite; }
        .music-bars.playing .bar:nth-child(2) { animation: musicBar 0.6s ease 0.1s infinite; }
        .music-bars.playing .bar:nth-child(3) { animation: musicBar 0.7s ease 0.2s infinite; }
        .music-bars.playing .bar:nth-child(4) { animation: musicBar 0.5s ease 0.15s infinite; }
        .music-bars:not(.playing) .bar { height: 3px !important; }
        @keyframes musicBar {
            0%, 100% { height: 4px; }
            50% { height: 14px; }
        }

        /* ========================================
           RESPONSIVE — MOBILE
           ======================================== */
        @media (max-width: 768px) {
            /* Header — stack brand + status vertically */
            .header-bar { padding: 16px 0 8px 0; }
            .header-bar .d-flex {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }
            .header-status { text-align: left; margin-top: 4px; }
            .brand-name { font-size: 15px; letter-spacing: 2px; }
            .brand-avatar { width: 36px; height: 36px; }
            .brand-subtitle { font-size: 11px; }

            /* Navigation — horizontal scroll with no overflow clipping */
            .nav-roman {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                margin: 12px -16px 20px -16px;
                padding: 0 16px 12px 16px;
                gap: 0;
                scrollbar-width: none;
            }
            .nav-roman::-webkit-scrollbar { display: none; }
            .nav-roman .nav-link {
                padding: 8px 10px;
                font-size: 9px;
                letter-spacing: 1px;
                white-space: nowrap;
            }
            .nav-separator { padding: 0 2px; }

            /* Hero quote */
            .hero-quote {
                font-size: 17px;
                padding: 8px 8px 16px;
            }

            /* Container padding — prevent left/right clip */
            .container-fluid.px-4 {
                padding-left: 16px !important;
                padding-right: 16px !important;
            }

            /* Cards */
            .card-body-inner { padding: 14px; }
            .card-header-rome { padding: 10px 14px; }
            .stat-value { font-size: 1.4rem; }
            .stat-mini { padding: 10px 12px; }
            .stat-label { font-size: 8px; letter-spacing: 1.5px; }

            /* Tables — smaller text */
            .table { font-size: 11px; }
            .table thead th { font-size: 8px; letter-spacing: 1px; padding: 8px 6px; }
            .table td { padding: 6px; }
            .addr { font-size: 10px; }

            /* Compass star — tighter to edge */
            .compass-star { top: 16px; right: 16px; font-size: 14px; }

            /* Music toggle — avoid overlapping content */
            .music-toggle { bottom: 16px; right: 16px; }

            /* Bust watermark — smaller on mobile */
            body::before { width: 60vh; height: 60vh; }

            /* Charts — ensure they don't overflow */
            .chart-container { padding: 10px; }
        }

        /* Extra small screens (iPhone SE etc) */
        @media (max-width: 375px) {
            .brand-name { font-size: 13px; letter-spacing: 1px; }
            .hero-quote { font-size: 15px; padding: 4px 4px 12px; }
            .nav-roman .nav-link { padding: 8px 8px; font-size: 8px; }
            .stat-value { font-size: 1.2rem; }
        }

        /* ========================================
           HERO QUOTE
           ======================================== */
        .hero-quote {
            font-family: var(--font-serif);
            font-size: 22px;
            font-style: italic;
            font-weight: 300;
            color: var(--text-secondary);
            text-align: center;
            padding: 8px 40px 20px;
            line-height: 1.4;
        }
        .hero-quote .attr {
            display: block;
            font-size: 11px;
            font-style: normal;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-top: 8px;
            font-family: var(--font-display);
        }
    </style>
</head>
<body>

<!-- ============================================
     SPLASH SCREEN
     ============================================ -->
<div class="splash-screen" id="splash" onclick="enterApp()">
    <!-- Large bust watermark background -->
    <div class="splash-bg-bust"></div>
    <!-- CRT static noise layer — rendered by JS canvas -->
    <canvas class="crt-static" id="crtStatic"></canvas>
    <!-- Scan lines overlay -->
    <div class="crt-scanlines"></div>
    <!-- Moving scan bar -->
    <div class="crt-scanbar"></div>
    <!-- Text -->
    <div class="splash-title">Rome Agent</div>
    <div class="splash-enter">Click to Enter</div>
</div>

<!-- Compass Star -->
<div class="compass-star" title="Rome Agent Trader">&#10022;</div>

<!-- Trade Ticker -->
<div class="ticker-bar">
    <div class="ticker-content" id="ticker-content">
        <span style="letter-spacing: 2px;">AWAITING TRADE SIGNALS . . .</span>
    </div>
</div>

<!-- Header -->
<div class="header-bar">
    <div class="container-fluid px-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-brand">
                <img src="/static/images/bust-outline.png" alt="Rome" class="brand-avatar">
                <div>
                    <div class="brand-name">ROME AGENT TRADER</div>
                    <div class="brand-subtitle">Veni, Vidi, Traded</div>
                </div>
            </div>
            <div class="header-status">
                <div>
                    <span class="pulse-dot" id="status-dot"></span>
                    <span id="status-text" style="font-size: 12px; letter-spacing: 1px; font-weight: 500;">INITIALIZING</span>
                </div>
                <div style="margin-top: 4px;">
                    <span id="mode-badge" style="font-size: 11px; color: var(--accent-amber); letter-spacing: 1px;">---</span>
                </div>
                <div style="margin-top: 4px; font-size: 10px; color: var(--text-dim);" id="last-refresh">
                    Last sync: --:--:--
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- Hero Quote -->
    <div class="hero-quote fade-up">
        "Accompany me, it is time for Rome to shine."
        <span class="attr">Romulus</span>
    </div>

    <!-- Navigation -->
    <ul class="nav-roman" id="mainTabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="overview">Overview</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="wallets">Wallets</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="tokens">Tokens</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="trades">Trades</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="positions">Positions</a>
        </li>
        <li class="nav-separator">&#9670;</li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="clusters">Clusters</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div id="tab-overview"></div>
    <div id="tab-wallets" style="display:none"></div>
    <div id="tab-tokens" style="display:none"></div>
    <div id="tab-trades" style="display:none"></div>
    <div id="tab-positions" style="display:none"></div>
    <div id="tab-clusters" style="display:none"></div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<!-- Music Toggle -->
<div class="music-toggle" id="musicToggle" onclick="toggleMusic()" title="Toggle ambient music">
    <div class="music-bars" id="musicBars">
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
        <div class="bar" style="height:4px;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =========================================================================
// Chart.js Global Defaults — Roman Theme
// =========================================================================
Chart.defaults.color = '#8a8070';
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 11;

// =========================================================================
// Splash Screen
// =========================================================================
function enterApp() {
    // Start music on the splash click itself
    AudioSystem.init();
    AudioSystem.startMusic();
    document.getElementById('musicBars')?.classList.add('playing');
    document.getElementById('splash').classList.add('hidden');
}
// Splash only dismisses on click — no auto-enter

// =========================================================================
// Tab Navigation
// =========================================================================
const tabs = document.querySelectorAll('[data-tab]');
let activeTab = 'overview';

tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + name).style.display = 'block';
        activeTab = name;
        loadTab(name);
    });
});

// =========================================================================
// Helpers
// =========================================================================
function fmt(n, decimals = 4) {
    if (n === null || n === undefined) return '\u2014';
    return Number(n).toFixed(decimals);
}

function fmtPnl(n) {
    if (n === null || n === undefined) return '<span style="color:var(--text-dim)">\u2014</span>';
    const v = Number(n);
    const cls = v >= 0 ? 'pnl-positive' : 'pnl-negative';
    const sign = v >= 0 ? '+' : '';
    return `<span class="${cls}">${sign}${v.toFixed(6)} SOL</span>`;
}

function fmtUsd(n) {
    if (!n) return '<span style="color:var(--text-dim)">\u2014</span>';
    const v = Number(n);
    if (v >= 1_000_000) return '$' + (v / 1_000_000).toFixed(2) + 'M';
    if (v >= 1_000) return '$' + (v / 1_000).toFixed(1) + 'K';
    if (v >= 1) return '$' + v.toFixed(2);
    return '$' + v.toFixed(8);
}

function shortAddr(addr) {
    if (!addr || addr.length < 12) return addr || '\u2014';
    return addr.slice(0, 6) + '\u00b7\u00b7\u00b7' + addr.slice(-4);
}

function scoreColor(score) {
    if (score >= 80) return '#2d6b3f';
    if (score >= 60) return '#4a8c5c';
    if (score >= 40) return '#8b6914';
    return '#8b2c2c';
}

async function fetchApi(endpoint) {
    try {
        const res = await fetch(endpoint);
        if (!res.ok) return null;
        return res.json();
    } catch (e) {
        return null;
    }
}

function updateRefreshTimer() {
    const now = new Date();
    document.getElementById('last-refresh').textContent =
        'Last sync: ' + now.toLocaleTimeString('en-US', { hour12: false });
}

// =========================================================================
// Animated Number Counter
// =========================================================================
function animateCounter(elementId, newValue, decimals = 4) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const start = parseFloat(el.dataset.val || '0');
    const end = newValue;
    const startTime = performance.now();
    const duration = 600;
    el.dataset.val = end;

    function update(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * eased;
        el.textContent = current.toFixed(decimals);
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

// =========================================================================
// Ticker
// =========================================================================
function updateTicker(trades) {
    const el = document.getElementById('ticker-content');
    if (!trades || trades.length === 0) {
        el.innerHTML = '<span style="letter-spacing:2px;">AWAITING TRADE SIGNALS . . .</span>';
        return;
    }
    const items = trades.map(t => {
        const side = t.side.toUpperCase();
        const symbol = t.token_symbol || 'UNKNOWN';
        const amount = Number(t.amount_sol).toFixed(4);
        const color = t.side === 'buy' ? 'var(--accent-green)' : 'var(--accent-amber)';
        const time = t.created_at ? t.created_at.split('T').pop().split('.')[0] : '';
        return `<span style="color:${color}; font-weight:500;">${side}</span> ${symbol} ${amount} SOL <span style="color:var(--text-dim)">${time}</span>`;
    });
    el.innerHTML = items.join(' &nbsp;\u2022&nbsp; ') + ' &nbsp;\u2022&nbsp; ' + items.join(' &nbsp;\u2022&nbsp; ');
    el.style.animationDuration = Math.max(20, items.length * 4) + 's';
}

// =========================================================================
// Copy to Clipboard
// =========================================================================
function copyAddr(address, event) {
    if (event) event.stopPropagation();
    navigator.clipboard.writeText(address).then(() => {
        const el = event ? event.target : null;
        if (el) {
            const orig = el.textContent;
            el.textContent = 'Copied!';
            el.style.color = 'var(--accent-gold)';
            setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1000);
        }
    });
}

// =========================================================================
// Modal System
// =========================================================================
function showModal(titleText, bodyHTML) {
    document.getElementById('modal-container').innerHTML = `
        <div class="terminal-modal-overlay" onclick="closeModal(event)">
            <div class="terminal-modal" onclick="event.stopPropagation()">
                <div class="modal-titlebar">
                    <span>${titleText}</span>
                    <button class="modal-close" onclick="closeModal()">Close</button>
                </div>
                <div class="modal-body-inner">${bodyHTML}</div>
            </div>
        </div>
    `;
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-container').innerHTML = '';
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') document.getElementById('modal-container').innerHTML = '';
});

// =========================================================================
// Score Bar Renderer
// =========================================================================
function renderScoreBar(label, score) {
    const s = score || 0;
    const color = scoreColor(s);
    return `
        <div style="margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; font-size:10px;">
                <span style="color:var(--text-dim); font-family:var(--font-display); letter-spacing:1px; font-size:9px;">${label}</span>
                <span style="color:${color}; font-weight:500;">${s.toFixed(0)}</span>
            </div>
            <div class="score-bar"><div class="score-fill" style="width:${s}%; background:${color};"></div></div>
        </div>
    `;
}

// =========================================================================
// Wallet Detail Modal
// =========================================================================
async function showWalletDetail(address) {
    showModal('Loading...', '<div class="loading-text">Querying wallet data...</div>');
    const data = await fetchApi('/api/wallet/' + encodeURIComponent(address));
    if (!data || !data.wallet) { closeModal(); return; }

    const w = data.wallet;
    let html = `
        <div style="margin-bottom:20px;">
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px;">WALLET ADDRESS</div>
            <div class="addr-copy" onclick="copyAddr('${w.address}', event)"
                 style="font-size:13px; word-break:break-all; margin-top:4px;">
                ${w.address} <span style="color:var(--text-dim); font-size:9px;">[click to copy]</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            ${renderScoreBar('PNL SCORE', w.pnl_score)}
            ${renderScoreBar('WIN RATE', w.win_rate_score)}
            ${renderScoreBar('TIMING', w.timing_score)}
            ${renderScoreBar('CONSISTENCY', w.consistency_score)}
        </div>

        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">TOTAL SCORE</div>
                <div style="font-size:1.4rem; font-weight:600; color:${scoreColor(w.total_score)};">${w.total_score.toFixed(0)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">TOTAL PNL</div>
                <div style="font-size:1rem;">${fmtPnl(w.total_pnl_sol)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">WIN RATE</div>
                <div style="font-size:1.4rem; font-weight:600; color:var(--accent-green);">${w.win_rate.toFixed(0)}%</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">TRADES</div>
                <div style="font-size:1.4rem; font-weight:600; color:var(--text-secondary);">${w.total_trades}</div>
            </div>
        </div>
    `;

    if (data.token_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TOKEN TRADES (${data.token_trades.length})
            </div>
            <div class="table-responsive" style="margin-bottom:20px;">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Buy SOL</th><th>Sell SOL</th><th>PnL</th><th>Entry Rank</th>
                    </tr></thead>
                    <tbody>
                        ${data.token_trades.map(t => `
                        <tr>
                            <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                            <td>${fmt(t.buy_amount_sol, 4)}</td>
                            <td>${fmt(t.sell_amount_sol, 4)}</td>
                            <td>${fmtPnl(t.pnl_sol)}</td>
                            <td>${t.entry_rank || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    if (data.copy_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TRADES TRIGGERED (${data.copy_trades.length})
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Token</th><th>Side</th><th>SOL</th><th>Price</th><th>Status</th><th>Time</th>
                    </tr></thead>
                    <tbody>
                        ${data.copy_trades.map(t => `
                        <tr>
                            <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                            <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                            <td>${fmt(t.amount_sol, 6)}</td>
                            <td>${fmtUsd(t.price_usd)}</td>
                            <td>${t.status}</td>
                            <td style="white-space:nowrap">${t.created_at || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    showModal('Wallet \u2014 ' + shortAddr(w.address), html);
}

// =========================================================================
// Token Detail Modal
// =========================================================================
async function showTokenDetail(mint) {
    showModal('Loading...', '<div class="loading-text">Querying token data...</div>');
    const data = await fetchApi('/api/token/' + encodeURIComponent(mint));
    if (!data || !data.token) { closeModal(); return; }

    const t = data.token;
    let html = `
        <div style="margin-bottom:20px;">
            <div style="display:flex; align-items:baseline; gap:12px;">
                <span style="font-family:var(--font-display); font-size:1.2rem; font-weight:600; color:var(--text-primary);">${t.symbol || '???'}</span>
                <span style="color:var(--text-dim); font-size:12px; font-family:var(--font-serif); font-style:italic;">${t.name || ''}</span>
            </div>
            <div class="addr-copy" onclick="copyAddr('${t.mint_address}', event)"
                 style="font-size:11px; word-break:break-all; margin-top:4px; color:var(--text-dim);">
                ${t.mint_address} <span style="font-size:9px;">[click to copy]</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">MARKET CAP</div>
                <div style="font-size:1.1rem; color:var(--text-secondary);">${fmtUsd(t.market_cap_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">PRICE</div>
                <div style="font-size:1.1rem; color:var(--accent-green);">${fmtUsd(t.price_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">LIQUIDITY</div>
                <div style="font-size:1.1rem; color:var(--text-secondary);">${fmtUsd(t.liquidity_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">MULTIPLIER</div>
                <div style="font-size:1.1rem; color:var(--accent-gold); font-weight:600;">
                    ${t.price_multiplier ? t.price_multiplier.toFixed(1) + 'x' : '\u2014'}
                </div>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:20px;">
            <div class="stat-mini">
                <div class="stat-label">VOL 24H</div>
                <div style="color:var(--text-secondary);">${fmtUsd(t.volume_24h_usd)}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">HOLDERS</div>
                <div style="color:var(--text-secondary);">${t.holder_count || '\u2014'}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-label">SOURCE</div>
                <div style="color:var(--accent-amber);">${t.data_source || '\u2014'}</div>
            </div>
        </div>
    `;

    if (data.wallet_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                WALLETS THAT TRADED (${data.wallet_trades.length})
            </div>
            <div class="table-responsive" style="margin-bottom:20px;">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Wallet</th><th>Score</th><th>Buy SOL</th><th>PnL</th><th>Entry Rank</th><th>Status</th>
                    </tr></thead>
                    <tbody>
                        ${data.wallet_trades.map(wt => `
                        <tr>
                            <td class="addr">${shortAddr(wt.wallet_address)}</td>
                            <td><span style="color:${scoreColor(wt.total_score || 0)}">${wt.total_score ? wt.total_score.toFixed(0) : '\u2014'}</span></td>
                            <td>${fmt(wt.buy_amount_sol, 4)}</td>
                            <td>${fmtPnl(wt.pnl_sol)}</td>
                            <td>${wt.entry_rank || '\u2014'}</td>
                            <td>${wt.is_monitored ? '<span class="badge badge-monitored">MON</span>' : ''}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    if (data.copy_trades.length > 0) {
        html += `
            <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                TRADES (${data.copy_trades.length})
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr>
                        <th>Side</th><th>SOL</th><th>Price</th><th>Wallet</th><th>Status</th><th>Time</th>
                    </tr></thead>
                    <tbody>
                        ${data.copy_trades.map(ct => `
                        <tr>
                            <td><span class="badge badge-${ct.side}">${ct.side.toUpperCase()}</span></td>
                            <td>${fmt(ct.amount_sol, 6)}</td>
                            <td>${fmtUsd(ct.price_usd)}</td>
                            <td class="addr">${shortAddr(ct.triggered_by_wallet)}</td>
                            <td>${ct.status}</td>
                            <td style="white-space:nowrap">${ct.created_at || '\u2014'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    showModal('Token \u2014 ' + (t.symbol || shortAddr(t.mint_address)), html);
}

// =========================================================================
// Chart Instances
// =========================================================================
let pnlChart = null;
let walletScoreChart = null;
let winLossChart = null;
let tradeActivityChart = null;
let portfolioChart = null;

function destroyChart(chart) {
    if (chart) chart.destroy();
    return null;
}

// =========================================================================
// Chart: PnL
// =========================================================================
async function loadPnlChart() {
    const data = await fetchApi('/api/daily_pnl');
    const canvas = document.getElementById('pnlChart');
    if (!canvas || !data) return;

    pnlChart = destroyChart(pnlChart);
    const days = data.daily_pnl;
    if (days.length === 0) return;

    let cumulative = 0;
    const cumulativeData = days.map(d => { cumulative += d.total_pnl_sol; return cumulative; });

    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(184, 150, 12, 0.15)');
    gradient.addColorStop(1, 'rgba(184, 150, 12, 0)');

    pnlChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: days.map(d => d.date),
            datasets: [
                {
                    label: 'Daily PnL (SOL)',
                    data: days.map(d => d.total_pnl_sol),
                    borderColor: '#b8960c',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#b8960c',
                    pointBorderColor: '#b8960c',
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    tension: 0.3,
                    fill: true,
                },
                {
                    label: 'Cumulative PnL (SOL)',
                    data: cumulativeData,
                    borderColor: '#2d6b3f',
                    backgroundColor: 'rgba(45,107,63,0.05)',
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.3,
                    fill: true,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#8a8070', font: { size: 11 } } }
            },
            scales: {
                x: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } },
                y: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' } }
            }
        }
    });
}

// =========================================================================
// Chart: Wallet Score Distribution
// =========================================================================
async function loadWalletScoreChart() {
    const data = await fetchApi('/api/wallet_score_distribution');
    const canvas = document.getElementById('walletScoreChart');
    if (!canvas || !data) return;

    walletScoreChart = destroyChart(walletScoreChart);
    const dist = data.distribution;

    const barColors = ['#8b2c2c', '#8b6914', '#8b6914', '#4a8c5c', '#2d6b3f'];

    walletScoreChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: dist.map(d => d.range),
            datasets: [{
                label: 'Wallets',
                data: dist.map(d => d.count),
                backgroundColor: barColors.map(c => c + '40'),
                borderColor: barColors,
                borderWidth: 1,
                borderRadius: 3,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Score Distribution', color: '#5a5348', font: { size: 11, family: "'Inter', sans-serif" } }
            },
            scales: {
                x: { ticks: { color: '#8a8070' }, grid: { display: false } },
                y: { ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' }, beginAtZero: true }
            }
        }
    });
}

// =========================================================================
// Chart: Win/Loss Donut
// =========================================================================
function loadWinLossChart(stats) {
    const canvas = document.getElementById('winLossChart');
    if (!canvas || !stats) return;

    winLossChart = destroyChart(winLossChart);
    const wl = stats.win_loss;
    const total = wl.wins + wl.losses;

    winLossChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: ['Wins', 'Losses'],
            datasets: [{
                data: [wl.wins || 0, wl.losses || 0],
                backgroundColor: ['rgba(45,107,63,0.6)', 'rgba(139,44,44,0.6)'],
                borderColor: ['#2d6b3f', '#8b2c2c'],
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Win / Loss', color: '#5a5348', font: { size: 11 } }
            }
        },
        plugins: [{
            id: 'centerText',
            afterDraw(chart) {
                const { ctx, width, height } = chart;
                const rate = total > 0 ? ((wl.wins / total) * 100).toFixed(0) : '0';
                ctx.save();
                ctx.font = "600 22px 'Cormorant Garamond', serif";
                ctx.fillStyle = '#2d6b3f';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(rate + '%', width / 2, height / 2);
                ctx.restore();
            }
        }]
    });
}

// =========================================================================
// Chart: Trade Activity Timeline
// =========================================================================
function loadTradeActivityChart(stats) {
    const canvas = document.getElementById('tradeActivityChart');
    if (!canvas || !stats) return;

    tradeActivityChart = destroyChart(tradeActivityChart);
    const days = stats.daily_activity;
    if (days.length === 0) return;

    tradeActivityChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: days.map(d => d.date),
            datasets: [
                {
                    label: 'Buys',
                    data: days.map(d => d.buys),
                    backgroundColor: 'rgba(45,107,63,0.4)',
                    borderColor: '#2d6b3f',
                    borderWidth: 1,
                    borderRadius: 2,
                },
                {
                    label: 'Sells',
                    data: days.map(d => d.sells),
                    backgroundColor: 'rgba(139,105,20,0.4)',
                    borderColor: '#8b6914',
                    borderWidth: 1,
                    borderRadius: 2,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#8a8070', font: { size: 10 } } },
                title: { display: true, text: 'Trade Activity (30D)', color: '#5a5348', font: { size: 11 } }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#8a8070' }, grid: { display: false } },
                y: { stacked: true, ticks: { color: '#8a8070' }, grid: { color: '#e8e0d0' }, beginAtZero: true }
            }
        }
    });
}

// =========================================================================
// Chart: Portfolio Allocation
// =========================================================================
function loadPortfolioChart(stats) {
    const canvas = document.getElementById('portfolioChart');
    if (!canvas || !stats) return;

    portfolioChart = destroyChart(portfolioChart);
    const alloc = stats.portfolio_allocation;
    if (alloc.length === 0) return;

    const palette = ['#b8960c', '#2d6b3f', '#8b6914', '#5a7d6a', '#c4a84d', '#3d8b5c', '#a68a3c'];

    portfolioChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: alloc.map(a => a.token_symbol),
            datasets: [{
                data: alloc.map(a => a.amount_sol),
                backgroundColor: alloc.map((_, i) => (palette[i % palette.length]) + '60'),
                borderColor: alloc.map((_, i) => palette[i % palette.length]),
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            cutout: '60%',
            plugins: {
                legend: { position: 'right', labels: { color: '#8a8070', font: { size: 10 }, padding: 8 } },
                title: { display: true, text: 'Portfolio', color: '#5a5348', font: { size: 11 } }
            }
        }
    });
}

// =========================================================================
// Tab Loaders
// =========================================================================
async function loadTab(name) {
    switch (name) {
        case 'overview': return loadOverview();
        case 'wallets': return loadWallets();
        case 'tokens': return loadTokens();
        case 'trades': return loadTrades();
        case 'positions': return loadPositions();
        case 'clusters': return loadClusters();
    }
}

// =========================================================================
// OVERVIEW TAB
// =========================================================================
async function loadOverview() {
    const [data, tradeStats] = await Promise.all([
        fetchApi('/api/overview'),
        fetchApi('/api/trade_stats'),
    ]);

    if (!data) return;

    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const modeEl = document.getElementById('mode-badge');

    if (data.trading_paused) {
        statusText.textContent = 'Paused';
        statusText.style.color = 'var(--accent-amber)';
        statusDot.classList.add('pulse-dot-amber');
    } else {
        statusText.textContent = 'System Online';
        statusText.style.color = 'var(--accent-green)';
        statusDot.classList.remove('pulse-dot-amber');
    }

    const mode = data.trading_mode.toUpperCase();
    if (mode === 'LIVE') {
        modeEl.textContent = 'Live Trading';
        modeEl.style.color = 'var(--accent-red)';
    } else if (mode === 'DRY_RUN') {
        modeEl.textContent = 'Dry Run';
        modeEl.style.color = 'var(--accent-amber)';
    } else {
        modeEl.textContent = 'Alert Only';
        modeEl.style.color = 'var(--text-dim)';
    }

    const el = document.getElementById('tab-overview');
    el.innerHTML = `
        <div class="row g-3 mb-3">
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Positions</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" id="stat-positions">${data.open_positions}</div>
                        <div class="stat-label">Open</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Invested</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" id="stat-invested">${fmt(data.total_invested, 4)}</div>
                        <div class="stat-label">SOL Deployed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Unrealized</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmtPnl(data.unrealized_pnl)}</div>
                        <div class="stat-label">Open PnL</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">All Time</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmtPnl(data.all_time_pnl)}</div>
                        <div class="stat-label">Realized PnL</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Wallets</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" style="color:var(--text-secondary);">${data.monitored_wallets}</div>
                        <div class="stat-label">Monitored</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Scored</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" style="color:var(--text-secondary);">${data.total_wallets}</div>
                        <div class="stat-label">Wallets Analyzed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Discovery</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value" style="color:var(--text-secondary);">${data.total_tokens}</div>
                        <div class="stat-label">Tokens Found</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Today</span></div>
                    <div class="card-body-inner text-center">
                        <div class="stat-value">${fmtPnl(data.today_pnl)}</div>
                        <div class="stat-label">${data.today_buys} Buys / ${data.today_sells} Sells</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome"><span class="title-text">PnL Chart</span></div>
            <div class="chart-container">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Wallet Scores</span></div>
                    <div class="chart-container">
                        <canvas id="walletScoreChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Win / Loss</span></div>
                    <div class="chart-container">
                        <canvas id="winLossChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4 fade-up">
                <div class="rome-card chart-small">
                    <div class="card-header-rome"><span class="title-text">Portfolio</span></div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome"><span class="title-text">Trade Activity</span></div>
            <div class="chart-container">
                <canvas id="tradeActivityChart"></canvas>
            </div>
        </div>

        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Recent Trades</span>
                <span class="count-text">${data.recent_trades.length} entries</span>
            </div>
            <div class="card-body-inner">
                ${data.recent_trades.length > 0 ? `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Time</th><th>Token</th><th>Side</th><th>Amount</th><th>Status</th>
                        </tr></thead>
                        <tbody>
                            ${data.recent_trades.map(t => `
                            <tr onclick="showTokenDetail('${t.token_mint}')">
                                <td style="white-space:nowrap; color:var(--text-dim)">${t.created_at || '\u2014'}</td>
                                <td>${t.token_symbol || shortAddr(t.token_mint)}</td>
                                <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                                <td>${fmt(t.amount_sol, 6)} SOL</td>
                                <td>${t.status}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>` : '<div class="loading-text">Awaiting trade data...</div>'}
            </div>
        </div>
    `;

    loadPnlChart();
    loadWalletScoreChart();
    if (tradeStats) {
        loadWinLossChart(tradeStats);
        loadTradeActivityChart(tradeStats);
        loadPortfolioChart(tradeStats);
    }
    updateTicker(data.recent_trades);
    updateRefreshTimer();
}

// =========================================================================
// WALLETS TAB
// =========================================================================
async function loadWallets() {
    const data = await fetchApi('/api/wallets');
    const el = document.getElementById('tab-wallets');
    if (!data) return;

    if (data.wallets.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No Wallets Scored</h5>
            <p style="margin-top:12px;">Run discovery + analysis first:</p>
            <code>python main.py --discover</code><br><br>
            <code>python main.py --analyze</code>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Smart Wallet Leaderboard</span>
                <span class="count-text">${data.wallets.length} wallets</span>
            </div>
            <div class="card-body-inner">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>#</th><th>Address</th><th>Score</th><th>PnL</th>
                            <th>Win Rate</th><th>Trades</th><th>Timing</th><th>Status</th>
                        </tr></thead>
                        <tbody>
                            ${data.wallets.map((w, i) => `
                            <tr onclick="showWalletDetail('${w.address}')">
                                <td style="color:var(--text-dim)">${i + 1}</td>
                                <td class="addr">
                                    ${w.is_monitored ? '<span class="pulse-dot"></span>' : ''}${shortAddr(w.address)}
                                </td>
                                <td>
                                    <strong style="color:${scoreColor(w.total_score)}">${w.total_score.toFixed(0)}</strong>
                                    <div class="score-bar mt-1"><div class="score-fill" style="width:${w.total_score}%; background:${scoreColor(w.total_score)};"></div></div>
                                </td>
                                <td>${fmtPnl(w.total_pnl_sol)}</td>
                                <td>${w.win_rate.toFixed(0)}%</td>
                                <td>${w.total_trades}</td>
                                <td style="color:var(--text-dim)">Rank ${w.avg_entry_rank || '\u2014'}</td>
                                <td>
                                    ${w.is_monitored ? '<span class="badge badge-monitored">MON</span>' : ''}
                                    ${w.is_flagged ? '<span class="badge badge-flagged">' + (w.flag_reason || 'FLAG') + '</span>' : ''}
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    updateRefreshTimer();
}

// =========================================================================
// TOKENS TAB
// =========================================================================
async function loadTokens() {
    const data = await fetchApi('/api/tokens');
    const el = document.getElementById('tab-tokens');
    if (!data) return;

    if (data.tokens.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No Tokens Discovered</h5>
            <p style="margin-top:12px;">Run discovery:</p>
            <code>python main.py --discover</code>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Discovered Tokens</span>
                <span class="count-text">${data.tokens.length} tokens</span>
            </div>
            <div class="card-body-inner">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>#</th><th>Symbol</th><th>Multiplier</th><th>Market Cap</th>
                            <th>Liquidity</th><th>Vol 24h</th><th>Holders</th><th>Source</th>
                        </tr></thead>
                        <tbody>
                            ${data.tokens.map((t, i) => `
                            <tr onclick="showTokenDetail('${t.mint_address}')">
                                <td style="color:var(--text-dim)">${i + 1}</td>
                                <td>
                                    <strong style="color:var(--text-primary)">${t.symbol || '\u2014'}</strong>
                                    <br><span style="color:var(--text-dim); font-size:10px;">${t.name || ''}</span>
                                </td>
                                <td>
                                    <strong style="color:var(--accent-gold);">
                                        ${t.price_multiplier ? t.price_multiplier.toFixed(1) + 'x' : '\u2014'}
                                    </strong>
                                </td>
                                <td>${fmtUsd(t.market_cap_usd)}</td>
                                <td>${fmtUsd(t.liquidity_usd)}</td>
                                <td>${fmtUsd(t.volume_24h_usd)}</td>
                                <td>${t.holder_count || '\u2014'}</td>
                                <td style="color:var(--accent-amber)">${t.data_source || '\u2014'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    updateRefreshTimer();
}

// =========================================================================
// TRADES TAB
// =========================================================================
async function loadTrades() {
    const data = await fetchApi('/api/trades');
    const el = document.getElementById('tab-trades');
    if (!data) return;

    if (data.trades.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No Trades Executed</h5>
            <p style="margin-top:12px;">Trades will appear once the agent starts executing.</p>
        </div>`;
        return;
    }

    el.innerHTML = `
        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Trade History</span>
                <span class="count-text">${data.trades.length} records</span>
            </div>
            <div class="card-body-inner">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Time</th><th>Token</th><th>Side</th><th>SOL</th>
                            <th>Price</th><th>Triggered By</th><th>Reason</th><th>Status</th>
                        </tr></thead>
                        <tbody>
                            ${data.trades.map(t => `
                            <tr>
                                <td style="white-space:nowrap; color:var(--text-dim)">${t.created_at || '\u2014'}</td>
                                <td>
                                    <span style="cursor:pointer; color:var(--accent-gold);" onclick="showTokenDetail('${t.token_mint}')">
                                        ${t.token_symbol || shortAddr(t.token_mint)}
                                    </span>
                                </td>
                                <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                                <td>${fmt(t.amount_sol, 6)}</td>
                                <td>${fmtUsd(t.price_usd)}</td>
                                <td>
                                    <span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${t.triggered_by_wallet}')">
                                        ${shortAddr(t.triggered_by_wallet)}
                                    </span>
                                </td>
                                <td style="color:var(--text-dim)">${t.sell_reason || '\u2014'}</td>
                                <td>${t.status}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    updateRefreshTimer();
}

// =========================================================================
// POSITIONS TAB
// =========================================================================
async function loadPositions() {
    const data = await fetchApi('/api/positions');
    const el = document.getElementById('tab-positions');
    if (!data) return;

    if (data.positions.length === 0) {
        el.innerHTML = `<div class="empty-state">
            <h5>No Positions</h5>
            <p style="margin-top:12px;">Positions will appear once the agent executes trades.</p>
        </div>`;
        return;
    }

    const open = data.positions.filter(p => p.status === 'open');
    const closed = data.positions.filter(p => p.status === 'closed');

    el.innerHTML = `
        <div class="rome-card mb-3 fade-up">
            <div class="card-header-rome">
                <span class="title-text">Open Positions</span>
                <span class="count-text">${open.length} active</span>
            </div>
            <div class="card-body-inner">
                ${open.length > 0 ? `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Token</th><th>Invested</th><th>Entry</th><th>Current</th>
                            <th>Multiple</th><th>Unrealized PnL</th><th>Triggered By</th>
                        </tr></thead>
                        <tbody>
                            ${open.map(p => `
                            <tr>
                                <td>
                                    <span style="cursor:pointer; color:var(--accent-gold);" onclick="showTokenDetail('${p.token_mint}')">
                                        <strong>${p.token_symbol || shortAddr(p.token_mint)}</strong>
                                    </span>
                                </td>
                                <td>${fmt(p.amount_sol_invested, 4)} SOL</td>
                                <td>${fmtUsd(p.entry_price_usd)}</td>
                                <td>${fmtUsd(p.current_price_usd)}</td>
                                <td>
                                    ${p.multiplier ? `<strong style="color:${p.multiplier >= 1 ? 'var(--accent-green)' : 'var(--accent-red)'};">${p.multiplier.toFixed(2)}x</strong>` : '\u2014'}
                                </td>
                                <td>${fmtPnl(p.unrealized_pnl_sol)}</td>
                                <td>
                                    <span class="addr" style="cursor:pointer;" onclick="showWalletDetail('${p.triggered_by_wallet}')">
                                        ${shortAddr(p.triggered_by_wallet)}
                                    </span>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>` : '<div style="color:var(--text-dim); text-align:center; padding:20px; font-style:italic;">No open positions</div>'}
            </div>
        </div>

        <div class="rome-card fade-up">
            <div class="card-header-rome">
                <span class="title-text">Closed Positions</span>
                <span class="count-text">${closed.length} records</span>
            </div>
            <div class="card-body-inner">
                ${closed.length > 0 ? `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr>
                            <th>Token</th><th>Invested</th><th>Realized PnL</th>
                            <th>Reason</th><th>Opened</th><th>Closed</th>
                        </tr></thead>
                        <tbody>
                            ${closed.map(p => `
                            <tr>
                                <td>
                                    <span style="cursor:pointer; color:var(--text-secondary);" onclick="showTokenDetail('${p.token_mint}')">
                                        <strong>${p.token_symbol || shortAddr(p.token_mint)}</strong>
                                    </span>
                                </td>
                                <td>${fmt(p.amount_sol_invested, 4)} SOL</td>
                                <td>${fmtPnl(p.realized_pnl_sol)}</td>
                                <td style="color:var(--text-dim)">${p.close_reason || '\u2014'}</td>
                                <td style="color:var(--text-dim); white-space:nowrap;">${p.opened_at || '\u2014'}</td>
                                <td style="color:var(--text-dim); white-space:nowrap;">${p.closed_at || '\u2014'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>` : '<div style="color:var(--text-dim); text-align:center; padding:20px; font-style:italic;">No closed positions</div>'}
            </div>
        </div>
    `;
    updateRefreshTimer();
}

// =========================================================================
// CLUSTERS TAB
// =========================================================================
async function loadClusters() {
    const data = await fetchApi('/api/clusters');
    if (!data) return;

    const el = document.getElementById('tab-clusters');

    let html = `
        <div class="row g-3 mb-4" style="margin-top:4px;">
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Clusters</span></div>
                    <div class="card-body-inner text-center" style="padding:20px;">
                        <div class="stat-value" style="color:var(--accent-gold);">${data.total_clusters}</div>
                        <div class="stat-label">Clusters Found</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">Side Wallets</span></div>
                    <div class="card-body-inner text-center" style="padding:20px;">
                        <div class="stat-value" style="color:var(--accent-amber);">${data.total_side_wallets}</div>
                        <div class="stat-label">Identified</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-12 fade-up">
                <div class="rome-card">
                    <div class="card-header-rome"><span class="title-text">About Clusters</span></div>
                    <div class="card-body-inner" style="padding:16px; font-size:12px; color:var(--text-dim); line-height:1.8;">
                        Clusters are groups of wallets controlled by the same operator.<br>
                        <span style="color:var(--accent-gold); font-weight:500;">Side wallets</span> buy tokens before the public wallet,
                        giving us an early entry signal.<br>
                        Run <code style="color:var(--accent-gold); background:var(--bg-secondary); padding:2px 6px; border-radius:3px;">python main.py --clusters</code> to detect new clusters.
                    </div>
                </div>
            </div>
        </div>
    `;

    if (data.clusters.length === 0) {
        html += `
            <div class="rome-card fade-up">
                <div class="card-header-rome"><span class="title-text">No Clusters Yet</span></div>
                <div class="card-body-inner" style="text-align:center; padding:40px;">
                    <div style="font-family:var(--font-serif); font-size:16px; font-style:italic; color:var(--text-dim);">
                        Run --analyze then --clusters to discover wallet groups
                    </div>
                </div>
            </div>
        `;
    } else {
        data.clusters.forEach((c, idx) => {
            const members = c.members || [];
            const sideWallets = members.filter(m => m.is_side_wallet);
            const leadTime = c.avg_lead_time_seconds ? (c.avg_lead_time_seconds / 60).toFixed(1) + ' min' : '\u2014';

            html += `
                <div class="rome-card mb-3 fade-up">
                    <div class="card-header-rome">
                        <span class="title-text">Cluster ${idx + 1}</span>
                        <span class="count-text">
                            Seed: ${shortAddr(c.seed_wallet)} &nbsp;\u2022&nbsp;
                            Score: <span style="color:${scoreColor(c.seed_score || 0)}">${c.seed_score ? c.seed_score.toFixed(0) : '\u2014'}</span> &nbsp;\u2022&nbsp;
                            Members: ${c.total_members} &nbsp;\u2022&nbsp;
                            Lead: <span style="color:var(--accent-gold)">${leadTime}</span>
                        </span>
                    </div>
                    <div class="card-body-inner">
                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:16px;">
                            <div class="stat-mini">
                                <div class="stat-label">Seed Wallet</div>
                                <div class="addr-copy" onclick="copyAddr('${c.seed_wallet}', event)" style="font-size:11px; cursor:pointer;">
                                    ${shortAddr(c.seed_wallet)}
                                </div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-label">Best Side Wallet</div>
                                <div style="font-size:11px; color:var(--accent-gold);">
                                    ${c.best_side_wallet ? `<span class="addr-copy" onclick="copyAddr('${c.best_side_wallet}', event)" style="cursor:pointer;">${shortAddr(c.best_side_wallet)}</span>` : '\u2014'}
                                </div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-label">Avg Lead Time</div>
                                <div style="color:var(--accent-green); font-weight:500;">${leadTime}</div>
                            </div>
                            <div class="stat-mini">
                                <div class="stat-label">Side Wallets</div>
                                <div style="color:var(--accent-gold); font-weight:500;">${sideWallets.length}</div>
                            </div>
                        </div>

                        ${members.length > 0 ? `
                        <div style="color:var(--text-dim); font-family:var(--font-display); font-size:9px; letter-spacing:2px; margin-bottom:8px; border-bottom:1px solid var(--border-light); padding-bottom:4px;">
                            MEMBERS (${members.length})
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead><tr>
                                    <th>Wallet</th><th>Relationship</th><th>Confidence</th><th>Lead Time</th><th>Side?</th><th>Monitored</th>
                                </tr></thead>
                                <tbody>
                                    ${members.map(m => {
                                        const conf = (m.confidence * 100).toFixed(0);
                                        const confColor = m.confidence >= 0.7 ? 'var(--accent-green)' : m.confidence >= 0.4 ? 'var(--accent-amber)' : 'var(--text-dim)';
                                        const mLead = m.avg_lead_time_seconds ? (m.avg_lead_time_seconds / 60).toFixed(1) + 'm' : '\u2014';
                                        return `
                                        <tr style="${m.is_side_wallet ? 'background:rgba(184,150,12,0.04);' : ''}">
                                            <td>
                                                <span class="addr-copy" onclick="copyAddr('${m.wallet_address}', event)" style="cursor:pointer;">
                                                    ${shortAddr(m.wallet_address)}
                                                </span>
                                            </td>
                                            <td style="color:var(--text-dim); font-size:11px;">${m.relationship_type}</td>
                                            <td><span style="color:${confColor}">${conf}%</span></td>
                                            <td style="color:var(--accent-green);">${mLead}</td>
                                            <td>${m.is_side_wallet ? '<span style="color:var(--accent-gold); font-weight:600;">Yes</span>' : '<span style="color:var(--text-dim);">No</span>'}</td>
                                            <td>${m.is_monitored ? '<span class="badge badge-monitored">MON</span>' : ''}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>` : '<div style="color:var(--text-dim); text-align:center; padding:12px; font-style:italic;">No members</div>'}
                    </div>
                </div>
            `;
        });
    }

    el.innerHTML = html;
    updateRefreshTimer();
}

// =========================================================================
// Audio System — Ambient Music + UI Sounds
// =========================================================================
const AudioSystem = {
    ctx: null,
    musicPlaying: false,
    musicNodes: [],
    initialized: false,

    init() {
        if (this.initialized) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.initialized = true;
    },

    // Clock tick — sharp mechanical click like a clock hand advancing
    playClick() {
        if (!this.ctx) this.init();
        const t = this.ctx.currentTime;
        // Sharp attack oscillator — woody clock tick
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1800, t);
        osc.frequency.exponentialRampToValueAtTime(400, t + 0.015);
        gain.gain.setValueAtTime(0.12, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.06);
        // Resonant body — gives it that hollow clock case sound
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 800;
        filter.Q.value = 8;
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start(t);
        osc.stop(t + 0.07);
    },

    // Clock tock — softer, lower companion to the tick (hover)
    playHover() {
        if (!this.ctx) this.init();
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(1200, t);
        osc.frequency.exponentialRampToValueAtTime(300, t + 0.012);
        gain.gain.setValueAtTime(0.04, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 600;
        filter.Q.value = 6;
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start(t);
        osc.stop(t + 0.06);
    },

    // Ambient music — plays audio file
    startMusic() {
        if (this.musicPlaying) return;
        this.musicPlaying = true;

        if (!this.audioEl) {
            this.audioEl = new Audio('/static/audio/gloomy.mp3');
            this.audioEl.loop = true;
            this.audioEl.volume = 0.3;
        }
        this.audioEl.play().catch(() => {});
    },

    stopMusic() {
        this.musicPlaying = false;
        if (this.audioEl) {
            this.audioEl.pause();
        }
    }
};

function toggleMusic() {
    AudioSystem.init();
    if (AudioSystem.musicPlaying) {
        AudioSystem.stopMusic();
        document.getElementById('musicBars').classList.remove('playing');
    } else {
        AudioSystem.startMusic();
        document.getElementById('musicBars').classList.add('playing');
    }
}

// Click sounds on interactive elements
document.addEventListener('click', (e) => {
    const target = e.target.closest('a, button, .addr-copy, [onclick], .table-hover tbody tr, .nav-link');
    if (target && AudioSystem.initialized) {
        AudioSystem.playClick();
    }
});

// Hover sounds on nav links
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('mouseenter', () => {
        if (AudioSystem.initialized) AudioSystem.playHover();
    });
});

// Start music on first interaction (splash page load)
// Browsers require a user gesture before audio can play, so we listen for
// the very first click/touch anywhere and start music immediately
(function initMusicOnFirstInteraction() {
    function startOnInteraction() {
        AudioSystem.init();
        AudioSystem.startMusic();
        document.getElementById('musicBars')?.classList.add('playing');
        document.removeEventListener('click', startOnInteraction);
        document.removeEventListener('touchstart', startOnInteraction);
    }
    document.addEventListener('click', startOnInteraction, { once: true });
    document.addEventListener('touchstart', startOnInteraction, { once: true });
})();

// =========================================================================
// CRT Static Noise — animated TV noise on canvas
// =========================================================================
(function initCRTStatic() {
    const canvas = document.getElementById('crtStatic');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let animId;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    function drawStatic() {
        const w = canvas.width, h = canvas.height;
        const imageData = ctx.createImageData(w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const v = Math.random() * 255;
            data[i] = v;
            data[i + 1] = v;
            data[i + 2] = v;
            data[i + 3] = 255;
        }
        ctx.putImageData(imageData, 0, 0);
        animId = requestAnimationFrame(drawStatic);
    }
    drawStatic();

    // Stop static animation when splash is dismissed
    const observer = new MutationObserver(() => {
        if (document.getElementById('splash')?.classList.contains('hidden')) {
            cancelAnimationFrame(animId);
            observer.disconnect();
        }
    });
    observer.observe(document.getElementById('splash'), { attributes: true });
})();

// =========================================================================
// Subtle parallax on splash bust watermark
// =========================================================================
document.getElementById('splash')?.addEventListener('mousemove', (e) => {
    const bust = document.querySelector('.splash-bg-bust');
    if (!bust) return;
    const x = (e.clientX / window.innerWidth - 0.5) * 6;
    const y = (e.clientY / window.innerHeight - 0.5) * 6;
    bust.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
});

// =========================================================================
// Initial Load & Auto-Refresh
// =========================================================================
loadOverview();
setInterval(() => loadTab(activeTab), 30000);
</script>
</body>
</html>
